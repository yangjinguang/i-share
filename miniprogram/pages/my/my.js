"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var login_1 = require("../../utils/login");
var user_api_1 = require("../../apis/user-api");
var todo_api_1 = require("../../apis/todo-api");
var app = getApp();
Page({
    data: {
        userApi: {},
        profile: {},
        todoApi: {},
        roleTrans: ['', '游客', '管理员', '教师', '家长'],
    },
    onLoad: function () {
        this.setData({
            userApi: new user_api_1.UserApi(),
            todoApi: new todo_api_1.TodoApi()
        });
    },
    onShow: function () {
        this.getProfile();
        this.getTodoCount();
    },
    getProfile: function () {
        var _this = this;
        this.data.userApi.profile().then(function (profile) {
            app.globalData.profile = profile;
            _this.profileParse(profile);
        });
    },
    getTodoCount: function () {
        var _this = this;
        this.data.todoApi.getCount().then(function (result) {
            _this.setData({
                todoCount: result.count
            });
        });
    },
    profileParse: function (res) {
        var _this = this;
        var roles = res.roles.filter(function (r) { return r !== 0; }).map(function (r) { return _this.data.roleTrans[r]; });
        if (roles.length <= 0) {
            roles.push('游客');
        }
        res.isAdmin = res.roles.indexOf(2) > -1;
        res.isTeacher = res.roles.indexOf(3) > -1;
        app.globalData.profile = res;
        if (app.userInfoReadyCallback) {
            app.userInfoReadyCallback(res);
        }
        this.setData({
            profile: res,
            roles: roles,
            isLogin: true,
            isAdmin: res.isAdmin,
            isTeacher: res.isTeacher
        });
    },
    authSuccess: function () {
        var _this = this;
        login_1.Login(function (profile) {
            _this.profileParse(profile);
        });
    },
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibXkuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJteS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLDJDQUF3QztBQUd4QyxnREFBNEM7QUFDNUMsZ0RBQTRDO0FBRTVDLElBQU0sR0FBRyxHQUFHLE1BQU0sRUFBVSxDQUFDO0FBRTdCLElBQUksQ0FBQztJQUNELElBQUksRUFBRTtRQUNGLE9BQU8sRUFBVyxFQUFFO1FBQ3BCLE9BQU8sRUFBUSxFQUFFO1FBQ2pCLE9BQU8sRUFBVyxFQUFFO1FBQ3BCLFNBQVMsRUFBRSxDQUFDLEVBQUUsRUFBRSxJQUFJLEVBQUUsS0FBSyxFQUFFLElBQUksRUFBRSxJQUFJLENBQUM7S0FDM0M7SUFDRCxNQUFNO1FBQ0YsSUFBSSxDQUFDLE9BQU8sQ0FBQztZQUNULE9BQU8sRUFBRSxJQUFJLGtCQUFPLEVBQUU7WUFDdEIsT0FBTyxFQUFFLElBQUksa0JBQU8sRUFBRTtTQUN6QixDQUFDLENBQUM7SUFDUCxDQUFDO0lBQ0QsTUFBTTtRQUNGLElBQUksQ0FBQyxVQUFVLEVBQUUsQ0FBQztRQUNsQixJQUFJLENBQUMsWUFBWSxFQUFFLENBQUM7SUFDeEIsQ0FBQztJQUNELFVBQVU7UUFBVixpQkFLQztRQUpHLElBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLE9BQU8sRUFBRSxDQUFDLElBQUksQ0FBQyxVQUFBLE9BQU87WUFDcEMsR0FBRyxDQUFDLFVBQVUsQ0FBQyxPQUFPLEdBQUcsT0FBTyxDQUFDO1lBQ2pDLEtBQUksQ0FBQyxZQUFZLENBQUMsT0FBTyxDQUFDLENBQUM7UUFDL0IsQ0FBQyxDQUFDLENBQUM7SUFDUCxDQUFDO0lBQ0QsWUFBWTtRQUFaLGlCQU1DO1FBTEcsSUFBSSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsUUFBUSxFQUFFLENBQUMsSUFBSSxDQUFDLFVBQUEsTUFBTTtZQUNwQyxLQUFJLENBQUMsT0FBTyxDQUFDO2dCQUNULFNBQVMsRUFBRSxNQUFNLENBQUMsS0FBSzthQUMxQixDQUFDLENBQUM7UUFDUCxDQUFDLENBQUMsQ0FBQztJQUNQLENBQUM7SUFDRCxZQUFZLFlBQUMsR0FBUztRQUF0QixpQkFtQkM7UUFsQkcsSUFBTSxLQUFLLEdBQUcsR0FBRyxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsVUFBQSxDQUFDLElBQUksT0FBQSxDQUFDLEtBQUssQ0FBQyxFQUFQLENBQU8sQ0FBQyxDQUFDLEdBQUcsQ0FBQyxVQUFBLENBQUMsSUFBSSxPQUFBLEtBQUksQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxFQUF0QixDQUFzQixDQUFDLENBQUM7UUFDOUUsSUFBSSxLQUFLLENBQUMsTUFBTSxJQUFJLENBQUMsRUFBRTtZQUNuQixLQUFLLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO1NBQ3BCO1FBQ0QsR0FBRyxDQUFDLE9BQU8sR0FBRyxHQUFHLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQztRQUN4QyxHQUFHLENBQUMsU0FBUyxHQUFHLEdBQUcsQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO1FBQzFDLEdBQUcsQ0FBQyxVQUFVLENBQUMsT0FBTyxHQUFHLEdBQUcsQ0FBQztRQUM3QixJQUFJLEdBQUcsQ0FBQyxxQkFBcUIsRUFBRTtZQUMzQixHQUFHLENBQUMscUJBQXFCLENBQUMsR0FBRyxDQUFDLENBQUM7U0FDbEM7UUFDRCxJQUFJLENBQUMsT0FBTyxDQUFDO1lBQ1QsT0FBTyxFQUFFLEdBQUc7WUFDWixLQUFLLEVBQUUsS0FBSztZQUVaLE9BQU8sRUFBRSxJQUFJO1lBQ2IsT0FBTyxFQUFFLEdBQUcsQ0FBQyxPQUFPO1lBQ3BCLFNBQVMsRUFBRSxHQUFHLENBQUMsU0FBUztTQUMzQixDQUFDLENBQUM7SUFDUCxDQUFDO0lBQ0QsV0FBVztRQUFYLGlCQUlDO1FBSEcsYUFBSyxDQUFDLFVBQUMsT0FBTztZQUNWLEtBQUksQ0FBQyxZQUFZLENBQUMsT0FBTyxDQUFDLENBQUM7UUFDL0IsQ0FBQyxDQUFDLENBQUM7SUFDUCxDQUFDO0NBQ0osQ0FBQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtMb2dpbn0gZnJvbSAnLi4vLi4vdXRpbHMvbG9naW4nO1xuaW1wb3J0IHtVc2VyfSBmcm9tICcuLi8uLi91dGlscy90eXBlcy91c2VyJztcbmltcG9ydCB7SU15QXBwfSBmcm9tICcuLi8uLi9hcHAnO1xuaW1wb3J0IHtVc2VyQXBpfSBmcm9tICcuLi8uLi9hcGlzL3VzZXItYXBpJztcbmltcG9ydCB7VG9kb0FwaX0gZnJvbSAnLi4vLi4vYXBpcy90b2RvLWFwaSc7XG5cbmNvbnN0IGFwcCA9IGdldEFwcDxJTXlBcHA+KCk7XG5cblBhZ2Uoe1xuICAgIGRhdGE6IHtcbiAgICAgICAgdXNlckFwaTogPFVzZXJBcGk+e30sXG4gICAgICAgIHByb2ZpbGU6IDxVc2VyPnt9LFxuICAgICAgICB0b2RvQXBpOiA8VG9kb0FwaT57fSxcbiAgICAgICAgcm9sZVRyYW5zOiBbJycsICfmuLjlrqInLCAn566h55CG5ZGYJywgJ+aVmeW4iCcsICflrrbplb8nXSxcbiAgICB9LFxuICAgIG9uTG9hZCgpIHtcbiAgICAgICAgdGhpcy5zZXREYXRhKHtcbiAgICAgICAgICAgIHVzZXJBcGk6IG5ldyBVc2VyQXBpKCksXG4gICAgICAgICAgICB0b2RvQXBpOiBuZXcgVG9kb0FwaSgpXG4gICAgICAgIH0pO1xuICAgIH0sXG4gICAgb25TaG93KCkge1xuICAgICAgICB0aGlzLmdldFByb2ZpbGUoKTtcbiAgICAgICAgdGhpcy5nZXRUb2RvQ291bnQoKTtcbiAgICB9LFxuICAgIGdldFByb2ZpbGUoKSB7XG4gICAgICAgIHRoaXMuZGF0YS51c2VyQXBpLnByb2ZpbGUoKS50aGVuKHByb2ZpbGUgPT4ge1xuICAgICAgICAgICAgYXBwLmdsb2JhbERhdGEucHJvZmlsZSA9IHByb2ZpbGU7XG4gICAgICAgICAgICB0aGlzLnByb2ZpbGVQYXJzZShwcm9maWxlKTtcbiAgICAgICAgfSk7XG4gICAgfSxcbiAgICBnZXRUb2RvQ291bnQoKSB7XG4gICAgICAgIHRoaXMuZGF0YS50b2RvQXBpLmdldENvdW50KCkudGhlbihyZXN1bHQgPT4ge1xuICAgICAgICAgICAgdGhpcy5zZXREYXRhKHtcbiAgICAgICAgICAgICAgICB0b2RvQ291bnQ6IHJlc3VsdC5jb3VudFxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0pO1xuICAgIH0sXG4gICAgcHJvZmlsZVBhcnNlKHJlczogVXNlcikge1xuICAgICAgICBjb25zdCByb2xlcyA9IHJlcy5yb2xlcy5maWx0ZXIociA9PiByICE9PSAwKS5tYXAociA9PiB0aGlzLmRhdGEucm9sZVRyYW5zW3JdKTtcbiAgICAgICAgaWYgKHJvbGVzLmxlbmd0aCA8PSAwKSB7XG4gICAgICAgICAgICByb2xlcy5wdXNoKCfmuLjlrqInKTtcbiAgICAgICAgfVxuICAgICAgICByZXMuaXNBZG1pbiA9IHJlcy5yb2xlcy5pbmRleE9mKDIpID4gLTE7XG4gICAgICAgIHJlcy5pc1RlYWNoZXIgPSByZXMucm9sZXMuaW5kZXhPZigzKSA+IC0xO1xuICAgICAgICBhcHAuZ2xvYmFsRGF0YS5wcm9maWxlID0gcmVzO1xuICAgICAgICBpZiAoYXBwLnVzZXJJbmZvUmVhZHlDYWxsYmFjaykge1xuICAgICAgICAgICAgYXBwLnVzZXJJbmZvUmVhZHlDYWxsYmFjayhyZXMpO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMuc2V0RGF0YSh7XG4gICAgICAgICAgICBwcm9maWxlOiByZXMsXG4gICAgICAgICAgICByb2xlczogcm9sZXMsXG4gICAgICAgICAgICAvLyBzaG93UmVnaXN0ZXJCdG46IHJvbGVzLmxlbmd0aCA8IDIsXG4gICAgICAgICAgICBpc0xvZ2luOiB0cnVlLFxuICAgICAgICAgICAgaXNBZG1pbjogcmVzLmlzQWRtaW4sXG4gICAgICAgICAgICBpc1RlYWNoZXI6IHJlcy5pc1RlYWNoZXJcbiAgICAgICAgfSk7XG4gICAgfSxcbiAgICBhdXRoU3VjY2VzcygpIHtcbiAgICAgICAgTG9naW4oKHByb2ZpbGUpID0+IHtcbiAgICAgICAgICAgIHRoaXMucHJvZmlsZVBhcnNlKHByb2ZpbGUpO1xuICAgICAgICB9KTtcbiAgICB9LFxufSk7XG4iXX0=