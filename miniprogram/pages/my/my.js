"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var login_1 = require("../../utils/login");
var user_api_1 = require("../../apis/user-api");
var todo_api_1 = require("../../apis/todo-api");
var app = getApp();
Page({
    data: {
        userApi: {},
        profile: {},
        todoApi: {},
        roleTrans: ['', '游客', '管理员', '教师', '家长'],
    },
    onLoad: function () {
        this.setData({
            userApi: new user_api_1.UserApi(),
            todoApi: new todo_api_1.TodoApi()
        });
    },
    onShow: function () {
        if (app.globalData.profile) {
            this.profileParse(app.globalData.profile);
        }
    },
    getTodoCount: function () {
        var _this = this;
        this.data.todoApi.getCount().then(function (result) {
            _this.setData({
                todoCount: result.count
            });
        });
    },
    profileParse: function (res) {
        var _this = this;
        var roles = res.roles.filter(function (r) { return r !== 0; }).map(function (r) { return _this.data.roleTrans[r]; });
        if (roles.length <= 0) {
            roles.push('游客');
        }
        res.isAdmin = res.roles.indexOf(2) > -1;
        res.isTeacher = res.roles.indexOf(3) > -1;
        app.globalData.profile = res;
        if (app.userInfoReadyCallback) {
            app.userInfoReadyCallback(res);
        }
        this.setData({
            profile: res,
            roles: roles,
            isLogin: true,
            isAdmin: res.isAdmin,
            isTeacher: res.isTeacher
        });
    },
    authSuccess: function () {
        var _this = this;
        login_1.Login(function (profile) {
            _this.profileParse(profile);
        });
    },
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibXkuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJteS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLDJDQUFzRTtBQUd0RSxnREFBNEM7QUFDNUMsZ0RBQTRDO0FBRTVDLElBQU0sR0FBRyxHQUFHLE1BQU0sRUFBVSxDQUFDO0FBRTdCLElBQUksQ0FBQztJQUNELElBQUksRUFBRTtRQUNGLE9BQU8sRUFBVyxFQUFFO1FBQ3BCLE9BQU8sRUFBUSxFQUFFO1FBQ2pCLE9BQU8sRUFBVyxFQUFFO1FBQ3BCLFNBQVMsRUFBRSxDQUFDLEVBQUUsRUFBRSxJQUFJLEVBQUUsS0FBSyxFQUFFLElBQUksRUFBRSxJQUFJLENBQUM7S0FDM0M7SUFDRCxNQUFNO1FBQ0YsSUFBSSxDQUFDLE9BQU8sQ0FBQztZQUNULE9BQU8sRUFBRSxJQUFJLGtCQUFPLEVBQUU7WUFDdEIsT0FBTyxFQUFFLElBQUksa0JBQU8sRUFBRTtTQUN6QixDQUFDLENBQUM7SUFDUCxDQUFDO0lBQ0QsTUFBTTtRQUNGLElBQUksR0FBRyxDQUFDLFVBQVUsQ0FBQyxPQUFPLEVBQUU7WUFDeEIsSUFBSSxDQUFDLFlBQVksQ0FBQyxHQUFHLENBQUMsVUFBVSxDQUFDLE9BQU8sQ0FBQyxDQUFDO1NBQzdDO0lBQ0wsQ0FBQztJQUNELFlBQVk7UUFBWixpQkFNQztRQUxHLElBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLFFBQVEsRUFBRSxDQUFDLElBQUksQ0FBQyxVQUFBLE1BQU07WUFDcEMsS0FBSSxDQUFDLE9BQU8sQ0FBQztnQkFDVCxTQUFTLEVBQUUsTUFBTSxDQUFDLEtBQUs7YUFDMUIsQ0FBQyxDQUFDO1FBQ1AsQ0FBQyxDQUFDLENBQUM7SUFDUCxDQUFDO0lBQ0QsWUFBWSxZQUFDLEdBQVM7UUFBdEIsaUJBbUJDO1FBbEJHLElBQU0sS0FBSyxHQUFHLEdBQUcsQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLFVBQUEsQ0FBQyxJQUFJLE9BQUEsQ0FBQyxLQUFLLENBQUMsRUFBUCxDQUFPLENBQUMsQ0FBQyxHQUFHLENBQUMsVUFBQSxDQUFDLElBQUksT0FBQSxLQUFJLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsRUFBdEIsQ0FBc0IsQ0FBQyxDQUFDO1FBQzlFLElBQUksS0FBSyxDQUFDLE1BQU0sSUFBSSxDQUFDLEVBQUU7WUFDbkIsS0FBSyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztTQUNwQjtRQUNELEdBQUcsQ0FBQyxPQUFPLEdBQUcsR0FBRyxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7UUFDeEMsR0FBRyxDQUFDLFNBQVMsR0FBRyxHQUFHLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQztRQUMxQyxHQUFHLENBQUMsVUFBVSxDQUFDLE9BQU8sR0FBRyxHQUFHLENBQUM7UUFDN0IsSUFBSSxHQUFHLENBQUMscUJBQXFCLEVBQUU7WUFDM0IsR0FBRyxDQUFDLHFCQUFxQixDQUFDLEdBQUcsQ0FBQyxDQUFDO1NBQ2xDO1FBQ0QsSUFBSSxDQUFDLE9BQU8sQ0FBQztZQUNULE9BQU8sRUFBRSxHQUFHO1lBQ1osS0FBSyxFQUFFLEtBQUs7WUFFWixPQUFPLEVBQUUsSUFBSTtZQUNiLE9BQU8sRUFBRSxHQUFHLENBQUMsT0FBTztZQUNwQixTQUFTLEVBQUUsR0FBRyxDQUFDLFNBQVM7U0FDM0IsQ0FBQyxDQUFDO0lBQ1AsQ0FBQztJQUNELFdBQVc7UUFBWCxpQkFJQztRQUhHLGFBQUssQ0FBQyxVQUFDLE9BQU87WUFDVixLQUFJLENBQUMsWUFBWSxDQUFDLE9BQU8sQ0FBQyxDQUFDO1FBQy9CLENBQUMsQ0FBQyxDQUFDO0lBQ1AsQ0FBQztDQUNKLENBQUMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7Q2hlY2tMb2dpblN0YXR1cywgR2V0UHJvZmlsZSwgTG9naW59IGZyb20gJy4uLy4uL3V0aWxzL2xvZ2luJztcbmltcG9ydCB7VXNlcn0gZnJvbSAnLi4vLi4vdXRpbHMvdHlwZXMvdXNlcic7XG5pbXBvcnQge0lNeUFwcH0gZnJvbSAnLi4vLi4vYXBwJztcbmltcG9ydCB7VXNlckFwaX0gZnJvbSAnLi4vLi4vYXBpcy91c2VyLWFwaSc7XG5pbXBvcnQge1RvZG9BcGl9IGZyb20gJy4uLy4uL2FwaXMvdG9kby1hcGknO1xuXG5jb25zdCBhcHAgPSBnZXRBcHA8SU15QXBwPigpO1xuXG5QYWdlKHtcbiAgICBkYXRhOiB7XG4gICAgICAgIHVzZXJBcGk6IDxVc2VyQXBpPnt9LFxuICAgICAgICBwcm9maWxlOiA8VXNlcj57fSxcbiAgICAgICAgdG9kb0FwaTogPFRvZG9BcGk+e30sXG4gICAgICAgIHJvbGVUcmFuczogWycnLCAn5ri45a6iJywgJ+euoeeQhuWRmCcsICfmlZnluIgnLCAn5a626ZW/J10sXG4gICAgfSxcbiAgICBvbkxvYWQoKSB7XG4gICAgICAgIHRoaXMuc2V0RGF0YSh7XG4gICAgICAgICAgICB1c2VyQXBpOiBuZXcgVXNlckFwaSgpLFxuICAgICAgICAgICAgdG9kb0FwaTogbmV3IFRvZG9BcGkoKVxuICAgICAgICB9KTtcbiAgICB9LFxuICAgIG9uU2hvdygpIHtcbiAgICAgICAgaWYgKGFwcC5nbG9iYWxEYXRhLnByb2ZpbGUpIHtcbiAgICAgICAgICAgIHRoaXMucHJvZmlsZVBhcnNlKGFwcC5nbG9iYWxEYXRhLnByb2ZpbGUpO1xuICAgICAgICB9XG4gICAgfSxcbiAgICBnZXRUb2RvQ291bnQoKSB7XG4gICAgICAgIHRoaXMuZGF0YS50b2RvQXBpLmdldENvdW50KCkudGhlbihyZXN1bHQgPT4ge1xuICAgICAgICAgICAgdGhpcy5zZXREYXRhKHtcbiAgICAgICAgICAgICAgICB0b2RvQ291bnQ6IHJlc3VsdC5jb3VudFxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0pO1xuICAgIH0sXG4gICAgcHJvZmlsZVBhcnNlKHJlczogVXNlcikge1xuICAgICAgICBjb25zdCByb2xlcyA9IHJlcy5yb2xlcy5maWx0ZXIociA9PiByICE9PSAwKS5tYXAociA9PiB0aGlzLmRhdGEucm9sZVRyYW5zW3JdKTtcbiAgICAgICAgaWYgKHJvbGVzLmxlbmd0aCA8PSAwKSB7XG4gICAgICAgICAgICByb2xlcy5wdXNoKCfmuLjlrqInKTtcbiAgICAgICAgfVxuICAgICAgICByZXMuaXNBZG1pbiA9IHJlcy5yb2xlcy5pbmRleE9mKDIpID4gLTE7XG4gICAgICAgIHJlcy5pc1RlYWNoZXIgPSByZXMucm9sZXMuaW5kZXhPZigzKSA+IC0xO1xuICAgICAgICBhcHAuZ2xvYmFsRGF0YS5wcm9maWxlID0gcmVzO1xuICAgICAgICBpZiAoYXBwLnVzZXJJbmZvUmVhZHlDYWxsYmFjaykge1xuICAgICAgICAgICAgYXBwLnVzZXJJbmZvUmVhZHlDYWxsYmFjayhyZXMpO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMuc2V0RGF0YSh7XG4gICAgICAgICAgICBwcm9maWxlOiByZXMsXG4gICAgICAgICAgICByb2xlczogcm9sZXMsXG4gICAgICAgICAgICAvLyBzaG93UmVnaXN0ZXJCdG46IHJvbGVzLmxlbmd0aCA8IDIsXG4gICAgICAgICAgICBpc0xvZ2luOiB0cnVlLFxuICAgICAgICAgICAgaXNBZG1pbjogcmVzLmlzQWRtaW4sXG4gICAgICAgICAgICBpc1RlYWNoZXI6IHJlcy5pc1RlYWNoZXJcbiAgICAgICAgfSk7XG4gICAgfSxcbiAgICBhdXRoU3VjY2VzcygpIHtcbiAgICAgICAgTG9naW4oKHByb2ZpbGUpID0+IHtcbiAgICAgICAgICAgIHRoaXMucHJvZmlsZVBhcnNlKHByb2ZpbGUpO1xuICAgICAgICB9KTtcbiAgICB9LFxufSk7XG4iXX0=