"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var student_api_1 = require("../../../apis/student-api");
var app = getApp();
Page({
    data: {
        profile: {},
        canMgr: false,
        classId: 0,
        className: '',
        studentApi: {},
        students: []
    },
    onLoad: function (query) {
        var classId = Number(query['classId']);
        var profile = app.globalData.profile;
        var canMgr = false;
        if (profile) {
            if (profile.isAdmin) {
                canMgr = true;
            }
            else {
                profile.classes.forEach(function (i) {
                    if (i.id === classId) {
                        canMgr = true;
                    }
                });
            }
        }
        this.setData({
            profile: profile,
            canMgr: canMgr,
            classId: classId,
            className: query['className'],
            studentApi: new student_api_1.StudentApi()
        });
        console.log(this.data.canMgr);
    },
    onShow: function () {
        this.getStudents();
    },
    getStudents: function () {
        var _this = this;
        this.data.studentApi.getByClass(this.data.classId).then(function (result) {
            console.log(result);
            _this.setData({
                students: result
            });
        });
    },
    _studentCreate: function (studentId) {
        var url = '/pages/my/student-mgr/create/create?classId=' + this.data.classId;
        if (studentId) {
            url = url + '&studentId=' + studentId;
        }
        wx.navigateTo({
            url: url
        });
    },
    studentCreate: function () {
        this._studentCreate();
    },
    studentDelete: function (studentId) {
        var _this = this;
        this.data.studentApi.delete(studentId).then(function () {
            _this.getStudents();
        });
    },
    studentAction: function (e) {
        var _this = this;
        if (!this.data.canMgr) {
            return;
        }
        var studentId = e.currentTarget.dataset.studentId;
        wx.showActionSheet({
            itemList: ['编辑', '删除'],
            success: function (res) {
                switch (res.tapIndex) {
                    case 0:
                        if (studentId) {
                            _this._studentCreate(studentId);
                        }
                        break;
                    case 1:
                        if (studentId) {
                            _this.studentDelete(studentId);
                        }
                        break;
                }
            }
        });
    }
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3R1ZGVudC1tZ3IuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJzdHVkZW50LW1nci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLHlEQUFxRDtBQUtyRCxJQUFNLEdBQUcsR0FBRyxNQUFNLEVBQVUsQ0FBQztBQUU3QixJQUFJLENBQUM7SUFDRCxJQUFJLEVBQUU7UUFDRixPQUFPLEVBQVEsRUFBRTtRQUNqQixNQUFNLEVBQUUsS0FBSztRQUNiLE9BQU8sRUFBRSxDQUFDO1FBQ1YsU0FBUyxFQUFFLEVBQUU7UUFDYixVQUFVLEVBQWMsRUFBRTtRQUMxQixRQUFRLEVBQWEsRUFBRTtLQUMxQjtJQUNELE1BQU0sRUFBTixVQUFPLEtBQVU7UUFDYixJQUFJLE9BQU8sR0FBRyxNQUFNLENBQUMsS0FBSyxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUM7UUFDdkMsSUFBSSxPQUFPLEdBQUcsR0FBRyxDQUFDLFVBQVUsQ0FBQyxPQUFPLENBQUM7UUFDckMsSUFBSSxNQUFNLEdBQUcsS0FBSyxDQUFDO1FBRW5CLElBQUksT0FBTyxFQUFFO1lBQ1QsSUFBSSxPQUFPLENBQUMsT0FBTyxFQUFFO2dCQUNqQixNQUFNLEdBQUcsSUFBSSxDQUFDO2FBQ2pCO2lCQUFNO2dCQUNILE9BQU8sQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLFVBQUEsQ0FBQztvQkFDckIsSUFBSSxDQUFDLENBQUMsRUFBRSxLQUFLLE9BQU8sRUFBRTt3QkFDbEIsTUFBTSxHQUFHLElBQUksQ0FBQztxQkFDakI7Z0JBQ0wsQ0FBQyxDQUFDLENBQUM7YUFDTjtTQUNKO1FBRUQsSUFBSSxDQUFDLE9BQU8sQ0FBQztZQUNULE9BQU8sRUFBRSxPQUFPO1lBQ2hCLE1BQU0sRUFBRSxNQUFNO1lBQ2QsT0FBTyxFQUFFLE9BQU87WUFDaEIsU0FBUyxFQUFFLEtBQUssQ0FBQyxXQUFXLENBQUM7WUFDN0IsVUFBVSxFQUFFLElBQUksd0JBQVUsRUFBRTtTQUMvQixDQUFDLENBQUM7UUFDSCxPQUFPLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUM7SUFDbEMsQ0FBQztJQUNELE1BQU07UUFDRixJQUFJLENBQUMsV0FBVyxFQUFFLENBQUM7SUFDdkIsQ0FBQztJQUNELFdBQVc7UUFBWCxpQkFPQztRQU5HLElBQUksQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDLElBQUksQ0FBQyxVQUFBLE1BQU07WUFDMUQsT0FBTyxDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUMsQ0FBQztZQUNwQixLQUFJLENBQUMsT0FBTyxDQUFDO2dCQUNULFFBQVEsRUFBRSxNQUFNO2FBQ25CLENBQUMsQ0FBQztRQUNQLENBQUMsQ0FBQyxDQUFDO0lBQ1AsQ0FBQztJQUNELGNBQWMsRUFBZCxVQUFlLFNBQWtCO1FBQzdCLElBQUksR0FBRyxHQUFHLDhDQUE4QyxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDO1FBQzdFLElBQUksU0FBUyxFQUFFO1lBQ1gsR0FBRyxHQUFHLEdBQUcsR0FBRyxhQUFhLEdBQUcsU0FBUyxDQUFDO1NBQ3pDO1FBQ0QsRUFBRSxDQUFDLFVBQVUsQ0FBQztZQUNWLEdBQUcsRUFBRSxHQUFHO1NBQ1gsQ0FBQyxDQUFDO0lBQ1AsQ0FBQztJQUNELGFBQWE7UUFDVCxJQUFJLENBQUMsY0FBYyxFQUFFLENBQUM7SUFDMUIsQ0FBQztJQUNELGFBQWEsRUFBYixVQUFjLFNBQWlCO1FBQS9CLGlCQUlDO1FBSEcsSUFBSSxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsTUFBTSxDQUFDLFNBQVMsQ0FBQyxDQUFDLElBQUksQ0FBQztZQUN4QyxLQUFJLENBQUMsV0FBVyxFQUFFLENBQUM7UUFDdkIsQ0FBQyxDQUFDLENBQUM7SUFDUCxDQUFDO0lBQ0QsYUFBYSxFQUFiLFVBQWMsQ0FBTTtRQUFwQixpQkFzQkM7UUFyQkcsSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsTUFBTSxFQUFFO1lBQ25CLE9BQU87U0FDVjtRQUNELElBQU0sU0FBUyxHQUFHLENBQUMsQ0FBQyxhQUFhLENBQUMsT0FBTyxDQUFDLFNBQVMsQ0FBQztRQUNwRCxFQUFFLENBQUMsZUFBZSxDQUFDO1lBQ2YsUUFBUSxFQUFFLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQztZQUN0QixPQUFPLEVBQUUsVUFBQyxHQUFHO2dCQUNULFFBQVEsR0FBRyxDQUFDLFFBQVEsRUFBRTtvQkFDbEIsS0FBSyxDQUFDO3dCQUNGLElBQUksU0FBUyxFQUFFOzRCQUNYLEtBQUksQ0FBQyxjQUFjLENBQUMsU0FBUyxDQUFDLENBQUM7eUJBQ2xDO3dCQUNELE1BQU07b0JBQ1YsS0FBSyxDQUFDO3dCQUNGLElBQUksU0FBUyxFQUFFOzRCQUNYLEtBQUksQ0FBQyxhQUFhLENBQUMsU0FBUyxDQUFDLENBQUM7eUJBQ2pDO3dCQUNELE1BQU07aUJBQ2I7WUFDTCxDQUFDO1NBQ0osQ0FBQyxDQUFDO0lBQ1AsQ0FBQztDQUNKLENBQUMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7U3R1ZGVudEFwaX0gZnJvbSAnLi4vLi4vLi4vYXBpcy9zdHVkZW50LWFwaSc7XG5pbXBvcnQge1N0dWRlbnR9IGZyb20gJy4uLy4uLy4uL3V0aWxzL3R5cGVzL3N0dWRlbnQnO1xuaW1wb3J0IHtJTXlBcHB9IGZyb20gJy4uLy4uLy4uL2FwcCc7XG5pbXBvcnQge1VzZXJ9IGZyb20gJy4uLy4uLy4uL3V0aWxzL3R5cGVzL3VzZXInO1xuXG5jb25zdCBhcHAgPSBnZXRBcHA8SU15QXBwPigpO1xuXG5QYWdlKHtcbiAgICBkYXRhOiB7XG4gICAgICAgIHByb2ZpbGU6IDxVc2VyPnt9LFxuICAgICAgICBjYW5NZ3I6IGZhbHNlLFxuICAgICAgICBjbGFzc0lkOiAwLFxuICAgICAgICBjbGFzc05hbWU6ICcnLFxuICAgICAgICBzdHVkZW50QXBpOiA8U3R1ZGVudEFwaT57fSxcbiAgICAgICAgc3R1ZGVudHM6IDxTdHVkZW50W10+W11cbiAgICB9LFxuICAgIG9uTG9hZChxdWVyeTogYW55KSB7XG4gICAgICAgIGxldCBjbGFzc0lkID0gTnVtYmVyKHF1ZXJ5WydjbGFzc0lkJ10pO1xuICAgICAgICBsZXQgcHJvZmlsZSA9IGFwcC5nbG9iYWxEYXRhLnByb2ZpbGU7XG4gICAgICAgIGxldCBjYW5NZ3IgPSBmYWxzZTtcblxuICAgICAgICBpZiAocHJvZmlsZSkge1xuICAgICAgICAgICAgaWYgKHByb2ZpbGUuaXNBZG1pbikge1xuICAgICAgICAgICAgICAgIGNhbk1nciA9IHRydWU7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHByb2ZpbGUuY2xhc3Nlcy5mb3JFYWNoKGkgPT4ge1xuICAgICAgICAgICAgICAgICAgICBpZiAoaS5pZCA9PT0gY2xhc3NJZCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgY2FuTWdyID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5zZXREYXRhKHtcbiAgICAgICAgICAgIHByb2ZpbGU6IHByb2ZpbGUsXG4gICAgICAgICAgICBjYW5NZ3I6IGNhbk1ncixcbiAgICAgICAgICAgIGNsYXNzSWQ6IGNsYXNzSWQsXG4gICAgICAgICAgICBjbGFzc05hbWU6IHF1ZXJ5WydjbGFzc05hbWUnXSxcbiAgICAgICAgICAgIHN0dWRlbnRBcGk6IG5ldyBTdHVkZW50QXBpKClcbiAgICAgICAgfSk7XG4gICAgICAgIGNvbnNvbGUubG9nKHRoaXMuZGF0YS5jYW5NZ3IpO1xuICAgIH0sXG4gICAgb25TaG93KCkge1xuICAgICAgICB0aGlzLmdldFN0dWRlbnRzKCk7XG4gICAgfSxcbiAgICBnZXRTdHVkZW50cygpIHtcbiAgICAgICAgdGhpcy5kYXRhLnN0dWRlbnRBcGkuZ2V0QnlDbGFzcyh0aGlzLmRhdGEuY2xhc3NJZCkudGhlbihyZXN1bHQgPT4ge1xuICAgICAgICAgICAgY29uc29sZS5sb2cocmVzdWx0KTtcbiAgICAgICAgICAgIHRoaXMuc2V0RGF0YSh7XG4gICAgICAgICAgICAgICAgc3R1ZGVudHM6IHJlc3VsdFxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0pO1xuICAgIH0sXG4gICAgX3N0dWRlbnRDcmVhdGUoc3R1ZGVudElkPzogbnVtYmVyKSB7XG4gICAgICAgIGxldCB1cmwgPSAnL3BhZ2VzL215L3N0dWRlbnQtbWdyL2NyZWF0ZS9jcmVhdGU/Y2xhc3NJZD0nICsgdGhpcy5kYXRhLmNsYXNzSWQ7XG4gICAgICAgIGlmIChzdHVkZW50SWQpIHtcbiAgICAgICAgICAgIHVybCA9IHVybCArICcmc3R1ZGVudElkPScgKyBzdHVkZW50SWQ7XG4gICAgICAgIH1cbiAgICAgICAgd3gubmF2aWdhdGVUbyh7XG4gICAgICAgICAgICB1cmw6IHVybFxuICAgICAgICB9KTtcbiAgICB9LFxuICAgIHN0dWRlbnRDcmVhdGUoKSB7XG4gICAgICAgIHRoaXMuX3N0dWRlbnRDcmVhdGUoKTtcbiAgICB9LFxuICAgIHN0dWRlbnREZWxldGUoc3R1ZGVudElkOiBudW1iZXIpIHtcbiAgICAgICAgdGhpcy5kYXRhLnN0dWRlbnRBcGkuZGVsZXRlKHN0dWRlbnRJZCkudGhlbigoKSA9PiB7XG4gICAgICAgICAgICB0aGlzLmdldFN0dWRlbnRzKCk7XG4gICAgICAgIH0pO1xuICAgIH0sXG4gICAgc3R1ZGVudEFjdGlvbihlOiBhbnkpIHtcbiAgICAgICAgaWYgKCF0aGlzLmRhdGEuY2FuTWdyKSB7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgY29uc3Qgc3R1ZGVudElkID0gZS5jdXJyZW50VGFyZ2V0LmRhdGFzZXQuc3R1ZGVudElkO1xuICAgICAgICB3eC5zaG93QWN0aW9uU2hlZXQoe1xuICAgICAgICAgICAgaXRlbUxpc3Q6IFsn57yW6L6RJywgJ+WIoOmZpCddLFxuICAgICAgICAgICAgc3VjY2VzczogKHJlcykgPT4ge1xuICAgICAgICAgICAgICAgIHN3aXRjaCAocmVzLnRhcEluZGV4KSB7XG4gICAgICAgICAgICAgICAgICAgIGNhc2UgMDpcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzdHVkZW50SWQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9zdHVkZW50Q3JlYXRlKHN0dWRlbnRJZCk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICAgICAgY2FzZSAxOlxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHN0dWRlbnRJZCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc3R1ZGVudERlbGV0ZShzdHVkZW50SWQpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICB9XG59KTtcbiJdfQ==