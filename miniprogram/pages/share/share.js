"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var share_api_1 = require("../../apis/share-api");
var utils_1 = require("../../utils/utils");
var comment_api_1 = require("../../apis/comment-api");
var class_api_1 = require("../../apis/class-api");
Page({
    data: {
        shareApi: {},
        commentApi: {},
        classApi: {},
        shares: [],
        sharePageData: {
            page: 1,
            size: 20
        },
        commentInputShown: false,
        selectedShare: {},
        classes: [],
        classesArr: [],
        classIndex: 0,
        filterClassId: 0
    },
    onLoad: function () {
        this.setData({
            shareApi: new share_api_1.ShareApi(),
            commentApi: new comment_api_1.CommentApi(),
            classApi: new class_api_1.ClassApi()
        });
    },
    onShow: function () {
        this.getClassTree();
        this.getShares(1);
    },
    getClassTree: function () {
        var _this = this;
        this.data.classApi.classList().then(function (result) {
            var classesArr = ['全部'];
            result.forEach(function (c) {
                classesArr.push(c.gradeName + ' ' + c.name);
            });
            _this.setData({
                classes: result,
                classTree: result,
                classesArr: classesArr
            });
        });
    },
    getShares: function (page, classId) {
        var _this = this;
        if (this.data.sharePageData.last && page > 1) {
            return;
        }
        classId = classId || this.data.filterClassId;
        page = page || this.data.sharePageData.page;
        this.data.shareApi.query(this.data.filterClassId, page, this.data.sharePageData.size).then(function (result) {
            if (result.list === null) {
                return;
            }
            utils_1.Utils.shareSerialize.apply(utils_1.Utils, [1].concat(result.list));
            var shares = _this.data.shares || [];
            if (page && page > 1) {
                if (result.list && result.list.length > 0) {
                    shares = shares.concat(result.list);
                }
            }
            else {
                shares = result.list;
            }
            _this.setData({
                shares: shares,
                sharePageData: result.pagination
            });
        });
    },
    bindClassFilterChange: function (e) {
        console.log(e.detail.value);
        if (this.data.classIndex === e.detail.value) {
            return;
        }
        var classId = 0;
        if (e.detail.value > 0) {
            classId = this.data.classes[e.detail.value - 1].id;
        }
        this.setData({
            classIndex: e.detail.value,
            filterClassId: classId
        });
        this.getShares(1, classId);
    },
    shareLike: function (e) {
        var _this = this;
        this.data.shareApi.like(e.currentTarget.dataset['shareId']).then(function (result) {
            _this.setData({
                shares: _this.data.shares.map(function (i) {
                    if (i.id === result.id) {
                        i.likeUserIds = result.likeUserIds;
                        i.likeUsers = result.likeUsers;
                        i.likeUsersView = utils_1.Utils.usersNameStr(i.likeUsers);
                        i.liked = result.liked;
                    }
                    return i;
                })
            });
        });
    },
    showCommentInput: function (e) {
        var findShare = this.data.shares.find(function (i) { return i.id == e.currentTarget.dataset['shareId']; });
        if (!findShare) {
            return;
        }
        this.setData({
            commentInputShown: true,
            selectedShare: findShare,
        });
    },
    hideCommentInput: function () {
        this.setData({
            commentInputShown: false,
        });
    },
    sendComment: function (e) {
        var _this = this;
        var selectedShare = this.data.selectedShare;
        if (!selectedShare) {
            wx.showToast({
                title: '未知错误',
                image: '/icons/exclamation-circle.png'
            });
            return;
        }
        this.data.shareApi.createComment(selectedShare.id, e.detail.value['body']).then(function (result) {
            _this.setData({
                shares: _this.data.shares.map(function (i) {
                    if (i.id === result.id) {
                        i.comments = result.comments;
                    }
                    return i;
                }),
                commentInputShown: false,
            });
        });
    },
    commentAction: function (e) {
        var _this = this;
        var shareId = e.currentTarget.dataset['shareId'];
        var commentId = e.currentTarget.dataset['commentId'];
        if (!shareId || !commentId) {
            return;
        }
        wx.showActionSheet({
            itemList: ['撤回'],
            success: function (res) {
                switch (res.tapIndex) {
                    case 0:
                        _this.data.commentApi.delete(e.currentTarget.dataset['commentId']).then(function () {
                            _this.setData({
                                shares: _this.data.shares.map(function (i) {
                                    if (i.id === shareId) {
                                        i.comments = i.comments.filter(function (j) { return j.id !== commentId; });
                                    }
                                    return i;
                                })
                            });
                        });
                        break;
                }
            }
        });
    },
    getMore: function () {
        this.getShares(this.data.sharePageData.page + 1);
    }
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2hhcmUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJzaGFyZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLGtEQUE4QztBQUc5QywyQ0FBd0M7QUFFeEMsc0RBQWtEO0FBRWxELGtEQUE4QztBQUU5QyxJQUFJLENBQUM7SUFDRCxJQUFJLEVBQUU7UUFDRixRQUFRLEVBQVksRUFBRTtRQUN0QixVQUFVLEVBQWMsRUFBRTtRQUMxQixRQUFRLEVBQVksRUFBRTtRQUN0QixNQUFNLEVBQVcsRUFBRTtRQUNuQixhQUFhLEVBQWM7WUFDdkIsSUFBSSxFQUFFLENBQUM7WUFDUCxJQUFJLEVBQUUsRUFBRTtTQUNYO1FBQ0QsaUJBQWlCLEVBQUUsS0FBSztRQUN4QixhQUFhLEVBQVMsRUFBRTtRQUN4QixPQUFPLEVBQVcsRUFBRTtRQUNwQixVQUFVLEVBQVksRUFBRTtRQUN4QixVQUFVLEVBQUUsQ0FBQztRQUNiLGFBQWEsRUFBRSxDQUFDO0tBQ25CO0lBQ0QsTUFBTTtRQUNGLElBQUksQ0FBQyxPQUFRLENBQUM7WUFDVixRQUFRLEVBQUUsSUFBSSxvQkFBUSxFQUFFO1lBQ3hCLFVBQVUsRUFBRSxJQUFJLHdCQUFVLEVBQUU7WUFDNUIsUUFBUSxFQUFFLElBQUksb0JBQVEsRUFBRTtTQUMzQixDQUFDLENBQUM7SUFDUCxDQUFDO0lBQ0QsTUFBTTtRQUNGLElBQUksQ0FBQyxZQUFZLEVBQUUsQ0FBQztRQUNwQixJQUFJLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQ3RCLENBQUM7SUFFRCxZQUFZO1FBQVosaUJBWUM7UUFYRyxJQUFJLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxTQUFTLEVBQUUsQ0FBQyxJQUFJLENBQUMsVUFBQSxNQUFNO1lBQ3RDLElBQUksVUFBVSxHQUFHLENBQUMsSUFBSSxDQUFDLENBQUM7WUFDeEIsTUFBTSxDQUFDLE9BQU8sQ0FBQyxVQUFBLENBQUM7Z0JBQ1osVUFBVSxDQUFDLElBQUksQ0FBQyxDQUFD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WUFDaEIsT0FBTyxFQUFFLFVBQUMsR0FBRztnQkFDVCxRQUFRLEdBQUcsQ0FBQyxRQUFRLEVBQUU7b0JBQ2xCLEtBQUssQ0FBQzt3QkFDRixLQUFJLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLGFBQWEsQ0FBQyxPQUFPLENBQUMsV0FBVyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUM7NEJBQ25FLEtBQUksQ0FBQyxPQUFRLENBQUM7Z0NBQ1YsTUFBTSxFQUFFLEtBQUksQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxVQUFBLENBQUM7b0NBQzFCLElBQUksQ0FBQyxDQUFDLEVBQUUsS0FBSyxPQUFPLEVBQUU7d0NBQ2xCLENBQUMsQ0FBQyxRQUFRLEdBQUcsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUMsVUFBQSxDQUFDLElBQUksT0FBQSxDQUFDLENBQUMsRUFBRSxLQUFLLFNBQVMsRUFBbEIsQ0FBa0IsQ0FBQyxDQUFDO3FDQUMzRDtvQ0FDRCxPQUFPLENBQUMsQ0FBQztnQ0FDYixDQUFDLENBQUM7NkJBQ0wsQ0FBQyxDQUFDO3dCQUNQLENBQUMsQ0FBQyxDQUFDO3dCQUNILE1BQU07aUJBQ2I7WUFDTCxDQUFDO1NBQ0osQ0FBQyxDQUFDO0lBQ1AsQ0FBQztJQUNELE9BQU87UUFDSCxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDLElBQUksR0FBRyxDQUFDLENBQUMsQ0FBQztJQUNyRCxDQUFDO0NBQ0osQ0FBQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtTaGFyZUFwaX0gZnJvbSAnLi4vLi4vYXBpcy9zaGFyZS1hcGknO1xuaW1wb3J0IHtTaGFyZX0gZnJvbSAnLi4vLi4vdXRpbHMvdHlwZXMvc2hhcmUnO1xuaW1wb3J0IHtQYWdpbmF0aW9ufSBmcm9tICcuLi8uLi91dGlscy90eXBlcy9wYWdpbmF0aW9uJztcbmltcG9ydCB7VXRpbHN9IGZyb20gJy4uLy4uL3V0aWxzL3V0aWxzJztcbmltcG9ydCB7V3hCaW5kRXZlbnR9IGZyb20gJy4uLy4uL3V0aWxzL3R5cGVzL3d4LWJpbmQtZXZlbnQnO1xuaW1wb3J0IHtDb21tZW50QXBpfSBmcm9tICcuLi8uLi9hcGlzL2NvbW1lbnQtYXBpJztcbmltcG9ydCB7Q2xhc3N9IGZyb20gJy4uLy4uL3V0aWxzL3R5cGVzL2NsYXNzJztcbmltcG9ydCB7Q2xhc3NBcGl9IGZyb20gJy4uLy4uL2FwaXMvY2xhc3MtYXBpJztcblxuUGFnZSh7XG4gICAgZGF0YToge1xuICAgICAgICBzaGFyZUFwaTogPFNoYXJlQXBpPnt9LFxuICAgICAgICBjb21tZW50QXBpOiA8Q29tbWVudEFwaT57fSxcbiAgICAgICAgY2xhc3NBcGk6IDxDbGFzc0FwaT57fSxcbiAgICAgICAgc2hhcmVzOiA8U2hhcmVbXT5bXSxcbiAgICAgICAgc2hhcmVQYWdlRGF0YTogPFBhZ2luYXRpb24+e1xuICAgICAgICAgICAgcGFnZTogMSxcbiAgICAgICAgICAgIHNpemU6IDIwXG4gICAgICAgIH0sXG4gICAgICAgIGNvbW1lbnRJbnB1dFNob3duOiBmYWxzZSxcbiAgICAgICAgc2VsZWN0ZWRTaGFyZTogPFNoYXJlPnt9LFxuICAgICAgICBjbGFzc2VzOiA8Q2xhc3NbXT5bXSxcbiAgICAgICAgY2xhc3Nlc0FycjogPHN0cmluZ1tdPltdLFxuICAgICAgICBjbGFzc0luZGV4OiAwLFxuICAgICAgICBmaWx0ZXJDbGFzc0lkOiAwXG4gICAgfSxcbiAgICBvbkxvYWQoKSB7XG4gICAgICAgIHRoaXMuc2V0RGF0YSEoe1xuICAgICAgICAgICAgc2hhcmVBcGk6IG5ldyBTaGFyZUFwaSgpLFxuICAgICAgICAgICAgY29tbWVudEFwaTogbmV3IENvbW1lbnRBcGkoKSxcbiAgICAgICAgICAgIGNsYXNzQXBpOiBuZXcgQ2xhc3NBcGkoKVxuICAgICAgICB9KTtcbiAgICB9LFxuICAgIG9uU2hvdygpIHtcbiAgICAgICAgdGhpcy5nZXRDbGFzc1RyZWUoKTtcbiAgICAgICAgdGhpcy5nZXRTaGFyZXMoMSk7XG4gICAgfSxcblxuICAgIGdldENsYXNzVHJlZSgpIHtcbiAgICAgICAgdGhpcy5kYXRhLmNsYXNzQXBpLmNsYXNzTGlzdCgpLnRoZW4ocmVzdWx0ID0+IHtcbiAgICAgICAgICAgIGxldCBjbGFzc2VzQXJyID0gWyflhajpg6gnXTtcbiAgICAgICAgICAgIHJlc3VsdC5mb3JFYWNoKGMgPT4ge1xuICAgICAgICAgICAgICAgIGNsYXNzZXNBcnIucHVzaChjLmdyYWRlTmFtZSArICcgJyArIGMubmFtZSk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIHRoaXMuc2V0RGF0YSh7XG4gICAgICAgICAgICAgICAgY2xhc3NlczogcmVzdWx0LFxuICAgICAgICAgICAgICAgIGNsYXNzVHJlZTogcmVzdWx0LFxuICAgICAgICAgICAgICAgIGNsYXNzZXNBcnI6IGNsYXNzZXNBcnJcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9KTtcbiAgICB9LFxuXG4gICAgZ2V0U2hhcmVzKHBhZ2U6IG51bWJlciwgY2xhc3NJZD86IG51bWJlcikge1xuICAgICAgICBpZiAodGhpcy5kYXRhLnNoYXJlUGFnZURhdGEubGFzdCAmJiBwYWdlID4gMSkge1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIGNsYXNzSWQgPSBjbGFzc0lkIHx8IHRoaXMuZGF0YS5maWx0ZXJDbGFzc0lkO1xuICAgICAgICBwYWdlID0gcGFnZSB8fCB0aGlzLmRhdGEuc2hhcmVQYWdlRGF0YS5wYWdlO1xuICAgICAgICB0aGlzLmRhdGEuc2hhcmVBcGkucXVlcnkodGhpcy5kYXRhLmZpbHRlckNsYXNzSWQsIHBhZ2UsIHRoaXMuZGF0YS5zaGFyZVBhZ2VEYXRhLnNpemUpLnRoZW4ocmVzdWx0ID0+IHtcbiAgICAgICAgICAgIGlmIChyZXN1bHQubGlzdCA9PT0gbnVsbCkge1xuICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIFV0aWxzLnNoYXJlU2VyaWFsaXplKDEsIC4uLnJlc3VsdC5saXN0KTtcbiAgICAgICAgICAgIGxldCBzaGFyZXMgPSB0aGlzLmRhdGEuc2hhcmVzIHx8IFtdO1xuICAgICAgICAgICAgaWYgKHBhZ2UgJiYgcGFnZSA+IDEpIHtcbiAgICAgICAgICAgICAgICBpZiAocmVzdWx0Lmxpc3QgJiYgcmVzdWx0Lmxpc3QubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgICAgICAgICBzaGFyZXMgPSBzaGFyZXMuY29uY2F0KHJlc3VsdC5saXN0KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHNoYXJlcyA9IHJlc3VsdC5saXN0O1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICB0aGlzLnNldERhdGEoe1xuICAgICAgICAgICAgICAgIHNoYXJlczogc2hhcmVzLFxuICAgICAgICAgICAgICAgIHNoYXJlUGFnZURhdGE6IHJlc3VsdC5wYWdpbmF0aW9uXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG4gICAgfSxcbiAgICBiaW5kQ2xhc3NGaWx0ZXJDaGFuZ2UoZTogV3hCaW5kRXZlbnQpIHtcbiAgICAgICAgY29uc29sZS5sb2coZS5kZXRhaWwudmFsdWUpO1xuICAgICAgICBpZiAodGhpcy5kYXRhLmNsYXNzSW5kZXggPT09IGUuZGV0YWlsLnZhbHVlKSB7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgbGV0IGNsYXNzSWQgPSAwO1xuICAgICAgICBpZiAoZS5kZXRhaWwudmFsdWUgPiAwKSB7XG4gICAgICAgICAgICBjbGFzc0lkID0gdGhpcy5kYXRhLmNsYXNzZXNbZS5kZXRhaWwudmFsdWUgLSAxXS5pZDtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLnNldERhdGEoe1xuICAgICAgICAgICAgY2xhc3NJbmRleDogZS5kZXRhaWwudmFsdWUsXG4gICAgICAgICAgICBmaWx0ZXJDbGFzc0lkOiBjbGFzc0lkXG4gICAgICAgIH0pO1xuICAgICAgICB0aGlzLmdldFNoYXJlcygxLCBjbGFzc0lkKTtcbiAgICB9LFxuICAgIHNoYXJlTGlrZShlOiBXeEJpbmRFdmVudCkge1xuICAgICAgICB0aGlzLmRhdGEuc2hhcmVBcGkubGlrZShlLmN1cnJlbnRUYXJnZXQuZGF0YXNldFsnc2hhcmVJZCddKS50aGVuKHJlc3VsdCA9PiB7XG4gICAgICAgICAgICB0aGlzLnNldERhdGEhKHtcbiAgICAgICAgICAgICAgICBzaGFyZXM6IHRoaXMuZGF0YS5zaGFyZXMubWFwKGkgPT4ge1xuICAgICAgICAgICAgICAgICAgICBpZiAoaS5pZCA9PT0gcmVzdWx0LmlkKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpLmxpa2VVc2VySWRzID0gcmVzdWx0Lmxpa2VVc2VySWRzO1xuICAgICAgICAgICAgICAgICAgICAgICAgaS5saWtlVXNlcnMgPSByZXN1bHQubGlrZVVzZXJzO1xuICAgICAgICAgICAgICAgICAgICAgICAgaS5saWtlVXNlcnNWaWV3ID0gVXRpbHMudXNlcnNOYW1lU3RyKGkubGlrZVVzZXJzKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGkubGlrZWQgPSByZXN1bHQubGlrZWQ7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGk7XG4gICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9KTtcbiAgICB9LFxuICAgIHNob3dDb21tZW50SW5wdXQoZTogV3hCaW5kRXZlbnQpIHtcbiAgICAgICAgY29uc3QgZmluZFNoYXJlID0gdGhpcy5kYXRhLnNoYXJlcy5maW5kKGkgPT4gaS5pZCA9PSBlLmN1cnJlbnRUYXJnZXQuZGF0YXNldFsnc2hhcmVJZCddKTtcbiAgICAgICAgaWYgKCFmaW5kU2hhcmUpIHtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLnNldERhdGEhKHtcbiAgICAgICAgICAgIGNvbW1lbnRJbnB1dFNob3duOiB0cnVlLFxuICAgICAgICAgICAgc2VsZWN0ZWRTaGFyZTogZmluZFNoYXJlLFxuICAgICAgICB9KTtcbiAgICB9LFxuICAgIGhpZGVDb21tZW50SW5wdXQoKSB7XG4gICAgICAgIHRoaXMuc2V0RGF0YSEoe1xuICAgICAgICAgICAgY29tbWVudElucHV0U2hvd246IGZhbHNlLFxuICAgICAgICB9KTtcbiAgICB9LFxuICAgIHNlbmRDb21tZW50KGU6IFd4QmluZEV2ZW50KSB7XG4gICAgICAgIGNvbnN0IHNlbGVjdGVkU2hhcmUgPSB0aGlzLmRhdGEuc2VsZWN0ZWRTaGFyZTtcbiAgICAgICAgaWYgKCFzZWxlY3RlZFNoYXJlKSB7XG4gICAgICAgICAgICB3eC5zaG93VG9hc3Qoe1xuICAgICAgICAgICAgICAgIHRpdGxlOiAn5pyq55+l6ZSZ6K+vJyxcbiAgICAgICAgICAgICAgICBpbWFnZTogJy9pY29ucy9leGNsYW1hdGlvbi1jaXJjbGUucG5nJ1xuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5kYXRhLnNoYXJlQXBpLmNyZWF0ZUNvbW1lbnQoc2VsZWN0ZWRTaGFyZS5pZCwgZS5kZXRhaWwudmFsdWVbJ2JvZHknXSkudGhlbihyZXN1bHQgPT4ge1xuICAgICAgICAgICAgdGhpcy5zZXREYXRhISh7XG4gICAgICAgICAgICAgICAgc2hhcmVzOiB0aGlzLmRhdGEuc2hhcmVzLm1hcChpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGkuaWQgPT09IHJlc3VsdC5pZCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgaS5jb21tZW50cyA9IHJlc3VsdC5jb21tZW50cztcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gaTtcbiAgICAgICAgICAgICAgICB9KSxcbiAgICAgICAgICAgICAgICBjb21tZW50SW5wdXRTaG93bjogZmFsc2UsXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG4gICAgfSxcbiAgICBjb21tZW50QWN0aW9uKGU6IFd4QmluZEV2ZW50KSB7XG4gICAgICAgIGNvbnN0IHNoYXJlSWQgPSBlLmN1cnJlbnRUYXJnZXQuZGF0YXNldFsnc2hhcmVJZCddO1xuICAgICAgICBjb25zdCBjb21tZW50SWQgPSBlLmN1cnJlbnRUYXJnZXQuZGF0YXNldFsnY29tbWVudElkJ107XG4gICAgICAgIGlmICghc2hhcmVJZCB8fCAhY29tbWVudElkKSB7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgd3guc2hvd0FjdGlvblNoZWV0KHtcbiAgICAgICAgICAgIGl0ZW1MaXN0OiBbJ+aSpOWbniddLFxuICAgICAgICAgICAgc3VjY2VzczogKHJlcykgPT4ge1xuICAgICAgICAgICAgICAgIHN3aXRjaCAocmVzLnRhcEluZGV4KSB7XG4gICAgICAgICAgICAgICAgICAgIGNhc2UgMDpcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZGF0YS5jb21tZW50QXBpLmRlbGV0ZShlLmN1cnJlbnRUYXJnZXQuZGF0YXNldFsnY29tbWVudElkJ10pLnRoZW4oKCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc2V0RGF0YSEoe1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzaGFyZXM6IHRoaXMuZGF0YS5zaGFyZXMubWFwKGkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGkuaWQgPT09IHNoYXJlSWQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpLmNvbW1lbnRzID0gaS5jb21tZW50cy5maWx0ZXIoaiA9PiBqLmlkICE9PSBjb21tZW50SWQpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgfSxcbiAgICBnZXRNb3JlKCkge1xuICAgICAgICB0aGlzLmdldFNoYXJlcyh0aGlzLmRhdGEuc2hhcmVQYWdlRGF0YS5wYWdlICsgMSk7XG4gICAgfVxufSk7XG4iXX0=