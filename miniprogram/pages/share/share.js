"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var share_api_1 = require("../../apis/share-api");
var utils_1 = require("../../utils/utils");
var comment_api_1 = require("../../apis/comment-api");
var class_api_1 = require("../../apis/class-api");
var app = getApp();
Page({
    data: {
        profile: {},
        shareApi: {},
        commentApi: {},
        classApi: {},
        shares: [],
        sharePageData: {
            page: 1,
            size: 20
        },
        commentInputShown: false,
        selectedShare: {},
        classes: [],
        classesArr: [],
        classIndex: 0,
        filterClassId: 0
    },
    onLoad: function () {
        this.setData({
            shareApi: new share_api_1.ShareApi(),
            commentApi: new comment_api_1.CommentApi(),
            classApi: new class_api_1.ClassApi()
        });
    },
    onShow: function () {
        this.setData({
            profile: app.globalData.profile,
        });
        console.log(app.globalData);
        console.log(this.data.profile);
        this.getClassTree();
        this.getShares(1);
    },
    getClassTree: function () {
        var _this = this;
        this.data.classApi.classList().then(function (result) {
            var classesArr = ['全部'];
            result.forEach(function (c) {
                classesArr.push(c.gradeName + ' ' + c.name);
            });
            _this.setData({
                classes: result,
                classTree: result,
                classesArr: classesArr
            });
        });
    },
    getShares: function (page, classId) {
        var _this = this;
        if (this.data.sharePageData.last && page > 1) {
            return;
        }
        classId = classId || this.data.filterClassId;
        page = page || this.data.sharePageData.page;
        this.data.shareApi.query(this.data.filterClassId, page, this.data.sharePageData.size).then(function (result) {
            if (result.list === null) {
                return;
            }
            utils_1.Utils.shareSerialize.apply(utils_1.Utils, [1].concat(result.list));
            var shares = _this.data.shares || [];
            if (page && page > 1) {
                if (result.list && result.list.length > 0) {
                    shares = shares.concat(result.list);
                }
            }
            else {
                shares = result.list;
            }
            _this.setData({
                shares: shares,
                sharePageData: result.pagination
            });
        });
    },
    getLikes: function (shareId) {
        var _this = this;
        this.data.shareApi.getLikes(shareId).then(function (likes) {
            _this.setData({
                shares: _this.data.shares.map(function (i) {
                    if (i.id === shareId) {
                        i.liked = likes.findIndex(function (j) { return j.id === _this.data.profile.id; }) > -1;
                        i.likes = likes;
                    }
                    return i;
                })
            });
        });
    },
    bindClassFilterChange: function (e) {
        console.log(e.detail.value);
        if (this.data.classIndex === e.detail.value) {
            return;
        }
        var classId = 0;
        if (e.detail.value > 0) {
            classId = this.data.classes[e.detail.value - 1].id;
        }
        this.setData({
            classIndex: e.detail.value,
            filterClassId: classId
        });
        this.getShares(1, classId);
    },
    shareLike: function (e) {
        var _this = this;
        var shareId = e.currentTarget.dataset['shareId'];
        this.data.shareApi.like(shareId).then(function () {
            _this.getLikes(shareId);
        });
    },
    showCommentInput: function (e) {
        var findShare = this.data.shares.find(function (i) { return i.id == e.currentTarget.dataset['shareId']; });
        if (!findShare) {
            return;
        }
        this.setData({
            commentInputShown: true,
            selectedShare: findShare,
        });
    },
    hideCommentInput: function () {
        this.setData({
            commentInputShown: false,
        });
    },
    sendComment: function (e) {
        var _this = this;
        var selectedShare = this.data.selectedShare;
        if (!selectedShare) {
            wx.showToast({
                title: '未知错误',
                image: '/icons/exclamation-circle.png'
            });
            return;
        }
        this.data.shareApi.comment(selectedShare.id, e.detail.value['body']).then(function (result) {
            _this.setData({
                commentInputShown: false,
            });
        });
    },
    commentAction: function (e) {
        var _this = this;
        var shareId = e.currentTarget.dataset['shareId'];
        var commentId = e.currentTarget.dataset['commentId'];
        if (!shareId || !commentId) {
            return;
        }
        wx.showActionSheet({
            itemList: ['撤回'],
            success: function (res) {
                switch (res.tapIndex) {
                    case 0:
                        _this.data.commentApi.delete(e.currentTarget.dataset['commentId']).then(function () {
                            _this.setData({
                                shares: _this.data.shares.map(function (i) {
                                    if (i.id === shareId) {
                                        i.comments = i.comments.filter(function (j) { return j.id !== commentId; });
                                    }
                                    return i;
                                })
                            });
                        });
                        break;
                }
            }
        });
    },
    getMore: function () {
        this.getShares(this.data.sharePageData.page + 1);
    }
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2hhcmUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJzaGFyZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLGtEQUE4QztBQUc5QywyQ0FBd0M7QUFFeEMsc0RBQWtEO0FBRWxELGtEQUE4QztBQUk5QyxJQUFNLEdBQUcsR0FBRyxNQUFNLEVBQVUsQ0FBQztBQUU3QixJQUFJLENBQUM7SUFDRCxJQUFJLEVBQUU7UUFDRixPQUFPLEVBQVEsRUFBRTtRQUNqQixRQUFRLEVBQVksRUFBRTtRQUN0QixVQUFVLEVBQWMsRUFBRTtRQUMxQixRQUFRLEVBQVksRUFBRTtRQUN0QixNQUFNLEVBQVcsRUFBRTtRQUNuQixhQUFhLEVBQWM7WUFDdkIsSUFBSSxFQUFFLENBQUM7WUFDUCxJQUFJLEVBQUUsRUFBRTtTQUNYO1FBQ0QsaUJBQWlCLEVBQUUsS0FBSztRQUN4QixhQUFhLEVBQVMsRUFBRTtRQUN4QixPQUFPLEVBQVcsRUFBRTtRQUNwQixVQUFVLEVBQVksRUFBRTtRQUN4QixVQUFVLEVBQUUsQ0FBQztRQUNiLGFBQWEsRUFBRSxDQUFDO0tBQ25CO0lBQ0QsTUFBTTtRQUNGLElBQUksQ0FBQyxPQUFPLENBQUM7WUFDVCxRQUFRLEVBQUUsSUFBSSxvQkFBUSxFQUFFO1lBQ3hCLFVBQVUsRUFBRSxJQUFJLHdCQUFVLEVBQUU7WUFDNUIsUUFBUSxFQUFFLElBQUksb0JBQVEsRUFBRTtTQUMzQixDQUFDLENBQUM7SUFDUCxDQUFDO0lBQ0QsTUFBTTtRQUNGLElBQUksQ0FBQyxPQUFPLENBQUM7WUFDVCxPQUFPLEVBQUUsR0FBRyxDQUFDLFVBQVUsQ0FBQyxPQUFPO1NBQ2xDLENBQUMsQ0FBQztRQUNILE9BQU8sQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLFVBQVUsQ0FBQyxDQUFDO1FBQzVCLE9BQU8sQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUMvQixJQUFJLENBQUMsWUFBWSxFQUFFLENBQUM7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QUMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7U2hhcmVBcGl9IGZyb20gJy4uLy4uL2FwaXMvc2hhcmUtYXBpJztcbmltcG9ydCB7U2hhcmV9IGZyb20gJy4uLy4uL3V0aWxzL3R5cGVzL3NoYXJlJztcbmltcG9ydCB7UGFnaW5hdGlvbn0gZnJvbSAnLi4vLi4vdXRpbHMvdHlwZXMvcGFnaW5hdGlvbic7XG5pbXBvcnQge1V0aWxzfSBmcm9tICcuLi8uLi91dGlscy91dGlscyc7XG5pbXBvcnQge1d4QmluZEV2ZW50fSBmcm9tICcuLi8uLi91dGlscy90eXBlcy93eC1iaW5kLWV2ZW50JztcbmltcG9ydCB7Q29tbWVudEFwaX0gZnJvbSAnLi4vLi4vYXBpcy9jb21tZW50LWFwaSc7XG5pbXBvcnQge0NsYXNzfSBmcm9tICcuLi8uLi91dGlscy90eXBlcy9jbGFzcyc7XG5pbXBvcnQge0NsYXNzQXBpfSBmcm9tICcuLi8uLi9hcGlzL2NsYXNzLWFwaSc7XG5pbXBvcnQge0lNeUFwcH0gZnJvbSAnLi4vLi4vYXBwJztcbmltcG9ydCB7VXNlcn0gZnJvbSAnLi4vLi4vdXRpbHMvdHlwZXMvdXNlcic7XG5cbmNvbnN0IGFwcCA9IGdldEFwcDxJTXlBcHA+KCk7XG5cblBhZ2Uoe1xuICAgIGRhdGE6IHtcbiAgICAgICAgcHJvZmlsZTogPFVzZXI+e30sXG4gICAgICAgIHNoYXJlQXBpOiA8U2hhcmVBcGk+e30sXG4gICAgICAgIGNvbW1lbnRBcGk6IDxDb21tZW50QXBpPnt9LFxuICAgICAgICBjbGFzc0FwaTogPENsYXNzQXBpPnt9LFxuICAgICAgICBzaGFyZXM6IDxTaGFyZVtdPltdLFxuICAgICAgICBzaGFyZVBhZ2VEYXRhOiA8UGFnaW5hdGlvbj57XG4gICAgICAgICAgICBwYWdlOiAxLFxuICAgICAgICAgICAgc2l6ZTogMjBcbiAgICAgICAgfSxcbiAgICAgICAgY29tbWVudElucHV0U2hvd246IGZhbHNlLFxuICAgICAgICBzZWxlY3RlZFNoYXJlOiA8U2hhcmU+e30sXG4gICAgICAgIGNsYXNzZXM6IDxDbGFzc1tdPltdLFxuICAgICAgICBjbGFzc2VzQXJyOiA8c3RyaW5nW10+W10sXG4gICAgICAgIGNsYXNzSW5kZXg6IDAsXG4gICAgICAgIGZpbHRlckNsYXNzSWQ6IDBcbiAgICB9LFxuICAgIG9uTG9hZCgpIHtcbiAgICAgICAgdGhpcy5zZXREYXRhKHtcbiAgICAgICAgICAgIHNoYXJlQXBpOiBuZXcgU2hhcmVBcGkoKSxcbiAgICAgICAgICAgIGNvbW1lbnRBcGk6IG5ldyBDb21tZW50QXBpKCksXG4gICAgICAgICAgICBjbGFzc0FwaTogbmV3IENsYXNzQXBpKClcbiAgICAgICAgfSk7XG4gICAgfSxcbiAgICBvblNob3coKSB7XG4gICAgICAgIHRoaXMuc2V0RGF0YSh7XG4gICAgICAgICAgICBwcm9maWxlOiBhcHAuZ2xvYmFsRGF0YS5wcm9maWxlLFxuICAgICAgICB9KTtcbiAgICAgICAgY29uc29sZS5sb2coYXBwLmdsb2JhbERhdGEpO1xuICAgICAgICBjb25zb2xlLmxvZyh0aGlzLmRhdGEucHJvZmlsZSk7XG4gICAgICAgIHRoaXMuZ2V0Q2xhc3NUcmVlKCk7XG4gICAgICAgIHRoaXMuZ2V0U2hhcmVzKDEpO1xuICAgIH0sXG5cbiAgICBnZXRDbGFzc1RyZWUoKSB7XG4gICAgICAgIHRoaXMuZGF0YS5jbGFzc0FwaS5jbGFzc0xpc3QoKS50aGVuKHJlc3VsdCA9PiB7XG4gICAgICAgICAgICBsZXQgY2xhc3Nlc0FyciA9IFsn5YWo6YOoJ107XG4gICAgICAgICAgICByZXN1bHQuZm9yRWFjaChjID0+IHtcbiAgICAgICAgICAgICAgICBjbGFzc2VzQXJyLnB1c2goYy5ncmFkZU5hbWUgKyAnICcgKyBjLm5hbWUpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB0aGlzLnNldERhdGEoe1xuICAgICAgICAgICAgICAgIGNsYXNzZXM6IHJlc3VsdCxcbiAgICAgICAgICAgICAgICBjbGFzc1RyZWU6IHJlc3VsdCxcbiAgICAgICAgICAgICAgICBjbGFzc2VzQXJyOiBjbGFzc2VzQXJyXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG4gICAgfSxcblxuICAgIGdldFNoYXJlcyhwYWdlOiBudW1iZXIsIGNsYXNzSWQ/OiBudW1iZXIpIHtcbiAgICAgICAgaWYgKHRoaXMuZGF0YS5zaGFyZVBhZ2VEYXRhLmxhc3QgJiYgcGFnZSA+IDEpIHtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgICBjbGFzc0lkID0gY2xhc3NJZCB8fCB0aGlzLmRhdGEuZmlsdGVyQ2xhc3NJZDtcbiAgICAgICAgcGFnZSA9IHBhZ2UgfHwgdGhpcy5kYXRhLnNoYXJlUGFnZURhdGEucGFnZTtcbiAgICAgICAgdGhpcy5kYXRhLnNoYXJlQXBpLnF1ZXJ5KHRoaXMuZGF0YS5maWx0ZXJDbGFzc0lkLCBwYWdlLCB0aGlzLmRhdGEuc2hhcmVQYWdlRGF0YS5zaXplKS50aGVuKHJlc3VsdCA9PiB7XG4gICAgICAgICAgICBpZiAocmVzdWx0Lmxpc3QgPT09IG51bGwpIHtcbiAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBVdGlscy5zaGFyZVNlcmlhbGl6ZSgxLCAuLi5yZXN1bHQubGlzdCk7XG4gICAgICAgICAgICBsZXQgc2hhcmVzID0gdGhpcy5kYXRhLnNoYXJlcyB8fCBbXTtcbiAgICAgICAgICAgIGlmIChwYWdlICYmIHBhZ2UgPiAxKSB7XG4gICAgICAgICAgICAgICAgaWYgKHJlc3VsdC5saXN0ICYmIHJlc3VsdC5saXN0Lmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgICAgICAgICAgc2hhcmVzID0gc2hhcmVzLmNvbmNhdChyZXN1bHQubGlzdCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBzaGFyZXMgPSByZXN1bHQubGlzdDtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgdGhpcy5zZXREYXRhKHtcbiAgICAgICAgICAgICAgICBzaGFyZXM6IHNoYXJlcyxcbiAgICAgICAgICAgICAgICBzaGFyZVBhZ2VEYXRhOiByZXN1bHQucGFnaW5hdGlvblxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0pO1xuICAgIH0sXG4gICAgZ2V0TGlrZXMoc2hhcmVJZDogbnVtYmVyKSB7XG4gICAgICAgIHRoaXMuZGF0YS5zaGFyZUFwaS5nZXRMaWtlcyhzaGFyZUlkKS50aGVuKGxpa2VzID0+IHtcbiAgICAgICAgICAgIHRoaXMuc2V0RGF0YSh7XG4gICAgICAgICAgICAgICAgc2hhcmVzOiB0aGlzLmRhdGEuc2hhcmVzLm1hcChpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGkuaWQgPT09IHNoYXJlSWQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGkubGlrZWQgPSBsaWtlcy5maW5kSW5kZXgoaiA9PiBqLmlkID09PSB0aGlzLmRhdGEucHJvZmlsZS5pZCkgPiAtMTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGkubGlrZXMgPSBsaWtlcztcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gaTtcbiAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0pO1xuICAgIH0sXG4gICAgYmluZENsYXNzRmlsdGVyQ2hhbmdlKGU6IFd4QmluZEV2ZW50KSB7XG4gICAgICAgIGNvbnNvbGUubG9nKGUuZGV0YWlsLnZhbHVlKTtcbiAgICAgICAgaWYgKHRoaXMuZGF0YS5jbGFzc0luZGV4ID09PSBlLmRldGFpbC52YWx1ZSkge1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIGxldCBjbGFzc0lkID0gMDtcbiAgICAgICAgaWYgKGUuZGV0YWlsLnZhbHVlID4gMCkge1xuICAgICAgICAgICAgY2xhc3NJZCA9IHRoaXMuZGF0YS5jbGFzc2VzW2UuZGV0YWlsLnZhbHVlIC0gMV0uaWQ7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5zZXREYXRhKHtcbiAgICAgICAgICAgIGNsYXNzSW5kZXg6IGUuZGV0YWlsLnZhbHVlLFxuICAgICAgICAgICAgZmlsdGVyQ2xhc3NJZDogY2xhc3NJZFxuICAgICAgICB9KTtcbiAgICAgICAgdGhpcy5nZXRTaGFyZXMoMSwgY2xhc3NJZCk7XG4gICAgfSxcbiAgICBzaGFyZUxpa2UoZTogV3hCaW5kRXZlbnQpIHtcbiAgICAgICAgbGV0IHNoYXJlSWQgPSBlLmN1cnJlbnRUYXJnZXQuZGF0YXNldFsnc2hhcmVJZCddO1xuICAgICAgICB0aGlzLmRhdGEuc2hhcmVBcGkubGlrZShzaGFyZUlkKS50aGVuKCgpID0+IHtcbiAgICAgICAgICAgIHRoaXMuZ2V0TGlrZXMoc2hhcmVJZCk7XG4gICAgICAgICAgICAvLyB0aGlzLnNldERhdGEhKHtcbiAgICAgICAgICAgIC8vICAgICBzaGFyZXM6IHRoaXMuZGF0YS5zaGFyZXMubWFwKGkgPT4ge1xuICAgICAgICAgICAgLy8gICAgICAgICBpZiAoaS5pZCA9PT0gcmVzdWx0LmlkKSB7XG4gICAgICAgICAgICAvLyAgICAgICAgICAgICBpLmxpa2VVc2VySWRzID0gcmVzdWx0Lmxpa2VVc2VySWRzO1xuICAgICAgICAgICAgLy8gICAgICAgICAgICAgaS5saWtlVXNlcnMgPSByZXN1bHQubGlrZVVzZXJzO1xuICAgICAgICAgICAgLy8gICAgICAgICAgICAgaS5saWtlVXNlcnNWaWV3ID0gVXRpbHMudXNlcnNOYW1lU3RyKGkubGlrZVVzZXJzKTtcbiAgICAgICAgICAgIC8vICAgICAgICAgICAgIGkubGlrZWQgPSByZXN1bHQubGlrZWQ7XG4gICAgICAgICAgICAvLyAgICAgICAgIH1cbiAgICAgICAgICAgIC8vICAgICAgICAgcmV0dXJuIGk7XG4gICAgICAgICAgICAvLyAgICAgfSlcbiAgICAgICAgICAgIC8vIH0pO1xuICAgICAgICB9KTtcbiAgICB9LFxuICAgIHNob3dDb21tZW50SW5wdXQoZTogV3hCaW5kRXZlbnQpIHtcbiAgICAgICAgY29uc3QgZmluZFNoYXJlID0gdGhpcy5kYXRhLnNoYXJlcy5maW5kKGkgPT4gaS5pZCA9PSBlLmN1cnJlbnRUYXJnZXQuZGF0YXNldFsnc2hhcmVJZCddKTtcbiAgICAgICAgaWYgKCFmaW5kU2hhcmUpIHtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLnNldERhdGEhKHtcbiAgICAgICAgICAgIGNvbW1lbnRJbnB1dFNob3duOiB0cnVlLFxuICAgICAgICAgICAgc2VsZWN0ZWRTaGFyZTogZmluZFNoYXJlLFxuICAgICAgICB9KTtcbiAgICB9LFxuICAgIGhpZGVDb21tZW50SW5wdXQoKSB7XG4gICAgICAgIHRoaXMuc2V0RGF0YSEoe1xuICAgICAgICAgICAgY29tbWVudElucHV0U2hvd246IGZhbHNlLFxuICAgICAgICB9KTtcbiAgICB9LFxuICAgIHNlbmRDb21tZW50KGU6IFd4QmluZEV2ZW50KSB7XG4gICAgICAgIGNvbnN0IHNlbGVjdGVkU2hhcmUgPSB0aGlzLmRhdGEuc2VsZWN0ZWRTaGFyZTtcbiAgICAgICAgaWYgKCFzZWxlY3RlZFNoYXJlKSB7XG4gICAgICAgICAgICB3eC5zaG93VG9hc3Qoe1xuICAgICAgICAgICAgICAgIHRpdGxlOiAn5pyq55+l6ZSZ6K+vJyxcbiAgICAgICAgICAgICAgICBpbWFnZTogJy9pY29ucy9leGNsYW1hdGlvbi1jaXJjbGUucG5nJ1xuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5kYXRhLnNoYXJlQXBpLmNvbW1lbnQoc2VsZWN0ZWRTaGFyZS5pZCwgZS5kZXRhaWwudmFsdWVbJ2JvZHknXSkudGhlbihyZXN1bHQgPT4ge1xuICAgICAgICAgICAgdGhpcy5zZXREYXRhKHtcbiAgICAgICAgICAgICAgICAvLyBzaGFyZXM6IHRoaXMuZGF0YS5zaGFyZXMubWFwKGkgPT4ge1xuICAgICAgICAgICAgICAgIC8vICAgICBpZiAoaS5pZCA9PT0gcmVzdWx0LnNoYXJlSWQpIHtcbiAgICAgICAgICAgICAgICAvLyAgICAgICAgIGkuY29tbWVudHMgPSByZXN1bHQuY29tbWVudHM7XG4gICAgICAgICAgICAgICAgLy8gICAgIH1cbiAgICAgICAgICAgICAgICAvLyAgICAgcmV0dXJuIGk7XG4gICAgICAgICAgICAgICAgLy8gfSksXG4gICAgICAgICAgICAgICAgY29tbWVudElucHV0U2hvd246IGZhbHNlLFxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0pO1xuICAgIH0sXG4gICAgY29tbWVudEFjdGlvbihlOiBXeEJpbmRFdmVudCkge1xuICAgICAgICBjb25zdCBzaGFyZUlkID0gZS5jdXJyZW50VGFyZ2V0LmRhdGFzZXRbJ3NoYXJlSWQnXTtcbiAgICAgICAgY29uc3QgY29tbWVudElkID0gZS5jdXJyZW50VGFyZ2V0LmRhdGFzZXRbJ2NvbW1lbnRJZCddO1xuICAgICAgICBpZiAoIXNoYXJlSWQgfHwgIWNvbW1lbnRJZCkge1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIHd4LnNob3dBY3Rpb25TaGVldCh7XG4gICAgICAgICAgICBpdGVtTGlzdDogWyfmkqTlm54nXSxcbiAgICAgICAgICAgIHN1Y2Nlc3M6IChyZXMpID0+IHtcbiAgICAgICAgICAgICAgICBzd2l0Y2ggKHJlcy50YXBJbmRleCkge1xuICAgICAgICAgICAgICAgICAgICBjYXNlIDA6XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmRhdGEuY29tbWVudEFwaS5kZWxldGUoZS5jdXJyZW50VGFyZ2V0LmRhdGFzZXRbJ2NvbW1lbnRJZCddKS50aGVuKCgpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnNldERhdGEhKHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2hhcmVzOiB0aGlzLmRhdGEuc2hhcmVzLm1hcChpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpLmlkID09PSBzaGFyZUlkKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaS5jb21tZW50cyA9IGkuY29tbWVudHMuZmlsdGVyKGogPT4gai5pZCAhPT0gY29tbWVudElkKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgIH0sXG4gICAgZ2V0TW9yZSgpIHtcbiAgICAgICAgdGhpcy5nZXRTaGFyZXModGhpcy5kYXRhLnNoYXJlUGFnZURhdGEucGFnZSArIDEpO1xuICAgIH1cbn0pO1xuIl19