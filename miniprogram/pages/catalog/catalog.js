"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var item_api_1 = require("../../apis/item-api");
var class_api_1 = require("../../apis/class-api");
Page({
    data: {
        itemApi: {},
        classApi: {},
        tags: [],
        tagsArr: [],
        items: [],
        classes: [],
        classTree: [],
        classesArr: [],
        classIndex: 0,
        tagIndex: 0,
        tagId: 0,
        page: 1,
        searchTimer: 0,
        searchResult: []
    },
    onLoad: function () {
        this.setData({
            itemApi: new item_api_1.ItemApi(),
            classApi: new class_api_1.ClassApi()
        });
    },
    onShow: function () {
        var _this = this;
        this.setData({
            tagsArr: [],
            items: [],
            classes: [],
            classTree: [],
            classesArr: [],
            classIndex: 0,
            tagIndex: 0,
            tagId: 0,
            page: 1
        });
        this.data.classApi.classTree().then(function (result) {
            var classes = [];
            var classesArr = ['全部'];
            result.forEach(function (g) {
                var _classes = g.classes || [];
                _classes.forEach(function (c) {
                    classesArr.push(g.name + ' ' + c.name);
                    classes.push(c);
                });
            });
            _this.setData({
                classes: classes,
                classTree: result,
                classesArr: classesArr
            });
        });
        this.data.itemApi.getTags().then(function (result) {
            _this.setData({
                tags: result,
                tagsArr: ['全部'].concat(result.map(function (i) { return i.name; }))
            });
        });
        this.itemsQuery();
    },
    tagSwitch: function (e) {
        var index = e.currentTarget.dataset.tagIndex;
        if (index !== this.data.tagIndex) {
            this.setData({
                tagIndex: index
            });
        }
        var tagId = 0;
        if (index >= 0) {
            tagId = this.data.tags[index].id;
        }
        this.setData({
            items: [],
            page: 1
        });
        this.itemsQuery(this.data.page, tagId);
    },
    itemsQuery: function (page, tagId) {
        var _this = this;
        page = page || this.data.page;
        tagId = tagId || this.data.tagId;
        this.data.itemApi.query(page, 20, tagId).then(function (result) {
            var items = _this.data.items || [];
            if (result.list && result.list.length > 0) {
                items = items.concat(result.list);
            }
            _this.setData({
                items: items,
                page: result.pagination.page
            });
        });
    },
    bindTagFilterChange: function (e) {
        var index = e.detail.value;
        var tagId = 0;
        if (index > 0) {
            tagId = this.data.tags[index - 1].id;
        }
        if (index !== this.data.tagIndex) {
            this.setData({
                tagIndex: index,
                tagId: tagId
            });
        }
        this.setData({
            items: [],
            page: 1
        });
        this.itemsQuery(this.data.page, tagId);
    },
    bindClassFilterChange: function (e) {
        console.log(e);
        this.setData({
            classIndex: e.detail.value
        });
    },
    toLoan: function (e) {
        wx.navigateTo({
            url: "/pages/item/loan/loan?id=" + e.currentTarget.dataset.itemId
        });
    },
    getMore: function (e) {
        console.log(e);
        this.itemsQuery(this.data.page + 1);
    },
    showInput: function () {
        this.setData({
            inputShowed: true
        });
    },
    hideInput: function () {
        this.setData({
            inputVal: '',
            inputShowed: false
        });
    },
    clearInput: function () {
        this.setData({
            inputVal: ''
        });
    },
    inputTyping: function (e) {
        var _this = this;
        this.setData({
            searchTimer: new Date().getTime()
        });
        setTimeout(function () {
            if (new Date().getTime() - _this.data.searchTimer >= 500) {
                _this.data.itemApi.search(e.detail.value).then(function (result) {
                    _this.setData({
                        searchResult: result,
                        inputVal: e.detail.value
                    });
                });
            }
        }, 500);
    },
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2F0YWxvZy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImNhdGFsb2cudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFDQSxnREFBNEM7QUFHNUMsa0RBQThDO0FBSzlDLElBQUksQ0FBQztJQUNELElBQUksRUFBRTtRQUNGLE9BQU8sRUFBVyxFQUFFO1FBQ3BCLFFBQVEsRUFBWSxFQUFFO1FBQ3RCLElBQUksRUFBYSxFQUFFO1FBQ25CLE9BQU8sRUFBWSxFQUFFO1FBQ3JCLEtBQUssRUFBVSxFQUFFO1FBQ2pCLE9BQU8sRUFBVyxFQUFFO1FBQ3BCLFNBQVMsRUFBVyxFQUFFO1FBQ3RCLFVBQVUsRUFBWSxFQUFFO1FBQ3hCLFVBQVUsRUFBRSxDQUFDO1FBQ2IsUUFBUSxFQUFFLENBQUM7UUFDWCxLQUFLLEVBQUUsQ0FBQztRQUNSLElBQUksRUFBRSxDQUFDO1FBQ1AsV0FBVyxFQUFFLENBQUM7UUFDZCxZQUFZLEVBQVMsRUFBRTtLQUMxQjtJQUNELE1BQU07UUFDRixJQUFJLENBQUMsT0FBTyxDQUFDO1lBQ1QsT0FBTyxFQUFFLElBQUksa0JBQU8sRUFBRTtZQUN0QixRQUFRLEVBQUUsSUFBSSxvQkFBUSxFQUFFO1NBQzNCLENBQUMsQ0FBQztJQUNQLENBQUM7SUFDRCxNQUFNO1FBQU4saUJBbUNDO1FBbENHLElBQUksQ0FBQyxPQUFPLENBQUM7WUFDVCxPQUFPLEVBQVksRUFBRTtZQUNyQixLQUFLLEVBQVUsRUFBRTtZQUNqQixPQUFPLEVBQVcsRUFBRTtZQUNwQixTQUFTLEVBQVcsRUFBRTtZQUN0QixVQUFVLEVBQVksRUFBRTtZQUN4QixVQUFVLEVBQUUsQ0FBQztZQUNiLFFBQVEsRUFBRSxDQUFDO1lBQ1gsS0FBSyxFQUFFLENBQUM7WUFDUixJQUFJLEVBQUUsQ0FBQztTQUNWLENBQUMsQ0FBQztRQUNILElBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLFNBQVMsRUFBRSxDQUFDLElBQUksQ0FBQyxVQUFBLE1BQU07WUFDdEMsSUFB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c0NvbnRlbnQiOlsiLy8gcGFnZXMvY2F0YWxvZy9jYXRhbG9nLmpzXG5pbXBvcnQge0l0ZW1BcGl9IGZyb20gJy4uLy4uL2FwaXMvaXRlbS1hcGknO1xuaW1wb3J0IHtJdGVtVGFnfSBmcm9tICcuLi8uLi91dGlscy90eXBlcy9pdGVtLXRhZyc7XG5pbXBvcnQge0l0ZW19IGZyb20gJy4uLy4uL3V0aWxzL3R5cGVzL2l0ZW0nO1xuaW1wb3J0IHtDbGFzc0FwaX0gZnJvbSAnLi4vLi4vYXBpcy9jbGFzcy1hcGknO1xuaW1wb3J0IHtHcmFkZX0gZnJvbSAnLi4vLi4vdXRpbHMvdHlwZXMvZ3JhZGUnO1xuaW1wb3J0IHtDbGFzc30gZnJvbSAnLi4vLi4vdXRpbHMvdHlwZXMvY2xhc3MnO1xuaW1wb3J0IHtXeEJpbmRFdmVudH0gZnJvbSAnLi4vLi4vdXRpbHMvdHlwZXMvd3gtYmluZC1ldmVudCc7XG5cblBhZ2Uoe1xuICAgIGRhdGE6IHtcbiAgICAgICAgaXRlbUFwaTogPEl0ZW1BcGk+e30sXG4gICAgICAgIGNsYXNzQXBpOiA8Q2xhc3NBcGk+e30sXG4gICAgICAgIHRhZ3M6IDxJdGVtVGFnW10+W10sXG4gICAgICAgIHRhZ3NBcnI6IDxzdHJpbmdbXT5bXSxcbiAgICAgICAgaXRlbXM6IDxJdGVtW10+W10sXG4gICAgICAgIGNsYXNzZXM6IDxDbGFzc1tdPltdLFxuICAgICAgICBjbGFzc1RyZWU6IDxHcmFkZVtdPltdLFxuICAgICAgICBjbGFzc2VzQXJyOiA8c3RyaW5nW10+W10sXG4gICAgICAgIGNsYXNzSW5kZXg6IDAsXG4gICAgICAgIHRhZ0luZGV4OiAwLFxuICAgICAgICB0YWdJZDogMCxcbiAgICAgICAgcGFnZTogMSxcbiAgICAgICAgc2VhcmNoVGltZXI6IDAsXG4gICAgICAgIHNlYXJjaFJlc3VsdDo8SXRlbVtdPltdXG4gICAgfSxcbiAgICBvbkxvYWQoKSB7XG4gICAgICAgIHRoaXMuc2V0RGF0YSh7XG4gICAgICAgICAgICBpdGVtQXBpOiBuZXcgSXRlbUFwaSgpLFxuICAgICAgICAgICAgY2xhc3NBcGk6IG5ldyBDbGFzc0FwaSgpXG4gICAgICAgIH0pO1xuICAgIH0sXG4gICAgb25TaG93KCkge1xuICAgICAgICB0aGlzLnNldERhdGEoe1xuICAgICAgICAgICAgdGFnc0FycjogPHN0cmluZ1tdPltdLFxuICAgICAgICAgICAgaXRlbXM6IDxJdGVtW10+W10sXG4gICAgICAgICAgICBjbGFzc2VzOiA8Q2xhc3NbXT5bXSxcbiAgICAgICAgICAgIGNsYXNzVHJlZTogPEdyYWRlW10+W10sXG4gICAgICAgICAgICBjbGFzc2VzQXJyOiA8c3RyaW5nW10+W10sXG4gICAgICAgICAgICBjbGFzc0luZGV4OiAwLFxuICAgICAgICAgICAgdGFnSW5kZXg6IDAsXG4gICAgICAgICAgICB0YWdJZDogMCxcbiAgICAgICAgICAgIHBhZ2U6IDFcbiAgICAgICAgfSk7XG4gICAgICAgIHRoaXMuZGF0YS5jbGFzc0FwaS5jbGFzc1RyZWUoKS50aGVuKHJlc3VsdCA9PiB7XG4gICAgICAgICAgICBsZXQgY2xhc3NlcyA9IDxDbGFzc1tdPltdO1xuICAgICAgICAgICAgbGV0IGNsYXNzZXNBcnIgPSBbJ+WFqOmDqCddO1xuICAgICAgICAgICAgcmVzdWx0LmZvckVhY2goZyA9PiB7XG4gICAgICAgICAgICAgICAgY29uc3QgX2NsYXNzZXMgPSBnLmNsYXNzZXMgfHwgW107XG4gICAgICAgICAgICAgICAgX2NsYXNzZXMuZm9yRWFjaChjID0+IHtcbiAgICAgICAgICAgICAgICAgICAgY2xhc3Nlc0Fyci5wdXNoKGcubmFtZSArICcgJyArIGMubmFtZSk7XG4gICAgICAgICAgICAgICAgICAgIGNsYXNzZXMucHVzaChjKTtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgdGhpcy5zZXREYXRhKHtcbiAgICAgICAgICAgICAgICBjbGFzc2VzOiBjbGFzc2VzLFxuICAgICAgICAgICAgICAgIGNsYXNzVHJlZTogcmVzdWx0LFxuICAgICAgICAgICAgICAgIGNsYXNzZXNBcnI6IGNsYXNzZXNBcnJcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9KTtcbiAgICAgICAgdGhpcy5kYXRhLml0ZW1BcGkuZ2V0VGFncygpLnRoZW4ocmVzdWx0ID0+IHtcbiAgICAgICAgICAgIHRoaXMuc2V0RGF0YSh7XG4gICAgICAgICAgICAgICAgdGFnczogcmVzdWx0LFxuICAgICAgICAgICAgICAgIHRhZ3NBcnI6IFsn5YWo6YOoJ10uY29uY2F0KHJlc3VsdC5tYXAoaSA9PiBpLm5hbWUpKVxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0pO1xuICAgICAgICB0aGlzLml0ZW1zUXVlcnkoKTtcbiAgICB9LFxuICAgIHRhZ1N3aXRjaChlOiBhbnkpIHtcbiAgICAgICAgY29uc3QgaW5kZXggPSBlLmN1cnJlbnRUYXJnZXQuZGF0YXNldC50YWdJbmRleDtcbiAgICAgICAgaWYgKGluZGV4ICE9PSB0aGlzLmRhdGEudGFnSW5kZXgpIHtcbiAgICAgICAgICAgIHRoaXMuc2V0RGF0YSh7XG4gICAgICAgICAgICAgICAgdGFnSW5kZXg6IGluZGV4XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgICAgICBsZXQgdGFnSWQgPSAwO1xuICAgICAgICBpZiAoaW5kZXggPj0gMCkge1xuICAgICAgICAgICAgdGFnSWQgPSB0aGlzLmRhdGEudGFnc1tpbmRleF0uaWQ7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5zZXREYXRhKHtcbiAgICAgICAgICAgIGl0ZW1zOiA8SXRlbVtdPltdLFxuICAgICAgICAgICAgcGFnZTogMVxuICAgICAgICB9KTtcbiAgICAgICAgdGhpcy5pdGVtc1F1ZXJ5KHRoaXMuZGF0YS5wYWdlLCB0YWdJZCk7XG4gICAgfSxcbiAgICBpdGVtc1F1ZXJ5KHBhZ2U/OiBudW1iZXIsIHRhZ0lkPzogbnVtYmVyKSB7XG4gICAgICAgIHBhZ2UgPSBwYWdlIHx8IHRoaXMuZGF0YS5wYWdlO1xuICAgICAgICB0YWdJZCA9IHRhZ0lkIHx8IHRoaXMuZGF0YS50YWdJZDtcbiAgICAgICAgdGhpcy5kYXRhLml0ZW1BcGkucXVlcnkocGFnZSwgMjAsIHRhZ0lkKS50aGVuKHJlc3VsdCA9PiB7XG4gICAgICAgICAgICBsZXQgaXRlbXMgPSB0aGlzLmRhdGEuaXRlbXMgfHwgW107XG4gICAgICAgICAgICBpZiAocmVzdWx0Lmxpc3QgJiYgcmVzdWx0Lmxpc3QubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgICAgIGl0ZW1zID0gaXRlbXMuY29uY2F0KHJlc3VsdC5saXN0KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHRoaXMuc2V0RGF0YSh7XG4gICAgICAgICAgICAgICAgaXRlbXM6IGl0ZW1zLFxuICAgICAgICAgICAgICAgIHBhZ2U6IHJlc3VsdC5wYWdpbmF0aW9uLnBhZ2VcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9KTtcbiAgICB9LFxuICAgIGJpbmRUYWdGaWx0ZXJDaGFuZ2UoZTogV3hCaW5kRXZlbnQpIHtcbiAgICAgICAgY29uc3QgaW5kZXggPSBlLmRldGFpbC52YWx1ZTtcblxuICAgICAgICBsZXQgdGFnSWQgPSAwO1xuICAgICAgICBpZiAoaW5kZXggPiAwKSB7XG4gICAgICAgICAgICB0YWdJZCA9IHRoaXMuZGF0YS50YWdzW2luZGV4IC0gMV0uaWQ7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKGluZGV4ICE9PSB0aGlzLmRhdGEudGFnSW5kZXgpIHtcbiAgICAgICAgICAgIHRoaXMuc2V0RGF0YSh7XG4gICAgICAgICAgICAgICAgdGFnSW5kZXg6IGluZGV4LFxuICAgICAgICAgICAgICAgIHRhZ0lkOiB0YWdJZFxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5zZXREYXRhKHtcbiAgICAgICAgICAgIGl0ZW1zOiA8SXRlbVtdPltdLFxuICAgICAgICAgICAgcGFnZTogMVxuICAgICAgICB9KTtcbiAgICAgICAgdGhpcy5pdGVtc1F1ZXJ5KHRoaXMuZGF0YS5wYWdlLCB0YWdJZCk7XG4gICAgfSxcbiAgICBiaW5kQ2xhc3NGaWx0ZXJDaGFuZ2UoZTogV3hCaW5kRXZlbnQpIHtcbiAgICAgICAgY29uc29sZS5sb2coZSk7XG4gICAgICAgIHRoaXMuc2V0RGF0YSh7XG4gICAgICAgICAgICBjbGFzc0luZGV4OiBlLmRldGFpbC52YWx1ZVxuICAgICAgICB9KTtcbiAgICB9LFxuICAgIHRvTG9hbihlOiBXeEJpbmRFdmVudCkge1xuICAgICAgICB3eC5uYXZpZ2F0ZVRvKHtcbiAgICAgICAgICAgIHVybDogYC9wYWdlcy9pdGVtL2xvYW4vbG9hbj9pZD0ke2UuY3VycmVudFRhcmdldC5kYXRhc2V0Lml0ZW1JZH1gXG4gICAgICAgIH0pO1xuICAgIH0sXG4gICAgZ2V0TW9yZShlOiBXeEJpbmRFdmVudCkge1xuICAgICAgICBjb25zb2xlLmxvZyhlKTtcbiAgICAgICAgdGhpcy5pdGVtc1F1ZXJ5KHRoaXMuZGF0YS5wYWdlICsgMSk7XG4gICAgfSxcbiAgICBzaG93SW5wdXQoKSB7XG4gICAgICAgIHRoaXMuc2V0RGF0YSh7XG4gICAgICAgICAgICBpbnB1dFNob3dlZDogdHJ1ZVxuICAgICAgICB9KTtcbiAgICB9LFxuICAgIGhpZGVJbnB1dCgpIHtcbiAgICAgICAgdGhpcy5zZXREYXRhKHtcbiAgICAgICAgICAgIGlucHV0VmFsOiAnJyxcbiAgICAgICAgICAgIGlucHV0U2hvd2VkOiBmYWxzZVxuICAgICAgICB9KTtcbiAgICB9LFxuICAgIGNsZWFySW5wdXQoKSB7XG4gICAgICAgIHRoaXMuc2V0RGF0YSh7XG4gICAgICAgICAgICBpbnB1dFZhbDogJydcbiAgICAgICAgfSk7XG4gICAgfSxcbiAgICBpbnB1dFR5cGluZyhlOiBhbnkpIHtcbiAgICAgICAgdGhpcy5zZXREYXRhKHtcbiAgICAgICAgICAgIHNlYXJjaFRpbWVyOiBuZXcgRGF0ZSgpLmdldFRpbWUoKVxuICAgICAgICB9KTtcbiAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICAgICAgICBpZiAobmV3IERhdGUoKS5nZXRUaW1lKCkgLSB0aGlzLmRhdGEuc2VhcmNoVGltZXIgPj0gNTAwKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5kYXRhLml0ZW1BcGkuc2VhcmNoKGUuZGV0YWlsLnZhbHVlKS50aGVuKHJlc3VsdCA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuc2V0RGF0YSh7XG4gICAgICAgICAgICAgICAgICAgICAgICBzZWFyY2hSZXN1bHQ6IHJlc3VsdCxcbiAgICAgICAgICAgICAgICAgICAgICAgIGlucHV0VmFsOiBlLmRldGFpbC52YWx1ZVxuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSwgNTAwKTtcbiAgICB9LFxufSk7XG4iXX0=