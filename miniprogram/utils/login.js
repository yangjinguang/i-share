"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var auth_api_1 = require("../apis/auth-api");
var user_api_1 = require("../apis/user-api");
function Login(cb) {
    var authApi = new auth_api_1.AuthApi();
    wx.login({
        success: function (_res) {
            wx.getSetting({
                success: function (res) {
                    if (res.authSetting['scope.userInfo']) {
                        wx.getUserInfo({
                            success: function (res) {
                                authApi.auth({
                                    code: _res.code,
                                    encryptedData: res.encryptedData,
                                    iv: res.iv,
                                    rawData: res.rawData,
                                    signature: res.signature
                                }).then((function (authRes) {
                                    try {
                                        wx.setStorageSync('accessToken', authRes.data.accessToken);
                                    }
                                    catch (e) {
                                    }
                                    cb(authRes.data.profile);
                                }));
                            }
                        });
                    }
                }
            });
        },
        fail: function (_err) {
            console.log(_err);
        }
    });
}
exports.Login = Login;
function CheckLoginStatus(successCb, failCb) {
    console.log(111);
    var clearLoginStatus = function () {
        wx.removeStorageSync('accessToken');
        wx.switchTab({
            url: '/pages/my/my'
        });
    };
    var token = wx.getStorageSync('accessToken');
    if (!token) {
        clearLoginStatus();
        return;
    }
    wx.checkSession({
        success: function () {
            wx.getSetting({
                success: function (res) {
                    console.log(res);
                    if (res.authSetting['scope.userInfo']) {
                        wx.getUserInfo({
                            success: function (res) {
                                successCb(res);
                            }
                        });
                    }
                    else {
                        failCb && failCb();
                        clearLoginStatus();
                    }
                },
                fail: function () {
                    failCb && failCb();
                    clearLoginStatus();
                }
            });
        },
        fail: function () {
            failCb && failCb();
            clearLoginStatus();
        }
    });
}
exports.CheckLoginStatus = CheckLoginStatus;
function GetProfile(app, cb) {
    var userApi = new user_api_1.UserApi();
    userApi.profile().then(function (res) {
        ProfileParse(app, res, cb);
    });
}
exports.GetProfile = GetProfile;
function ProfileParse(app, profile, cb) {
    var roleTrans = ['', '游客', '管理员', '教师', '家长'];
    var roles = profile.roles.filter(function (r) { return r !== 0; }).map(function (r) { return roleTrans[r]; });
    if (roles.length <= 0) {
        roles.push('游客');
    }
    profile.isAdmin = profile.roles.indexOf(2) > -1;
    profile.isTeacher = profile.roles.indexOf(3) > -1;
    app.globalData.profile = profile;
    if (app.userInfoReadyCallback) {
        app.userInfoReadyCallback(profile);
    }
    cb(app.globalData.profile);
}
exports.ProfileParse = ProfileParse;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibG9naW4uanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJsb2dpbi50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUNBLDZDQUF1RDtBQUd2RCw2Q0FBeUM7QUFHekMsU0FBZ0IsS0FBSyxDQUFDLEVBQTJCO0lBQzdDLElBQU0sT0FBTyxHQUFHLElBQUksa0JBQU8sRUFBRSxDQUFDO0lBRTlCLEVBQUUsQ0FBQyxLQUFLLENBQUM7UUFDTCxPQUFPLEVBQUUsVUFBQyxJQUFJO1lBRVYsRUFBRSxDQUFDLFVBQVUsQ0FBQztnQkFDVixPQUFPLEVBQUUsVUFBQyxHQUFHO29CQUNULElBQUksR0FBRyxDQUFDLFdBQVcsQ0FBQyxnQkFBZ0IsQ0FBQyxFQUFFO3dCQUVuQyxFQUFFLENBQUMsV0FBVyxDQUFDOzRCQUNYLE9BQU8sRUFBRSxVQUFBLEdBQUc7Z0NBQ1IsT0FBTyxDQUFDLElBQUksQ0FBZTtvQ0FDdkIsSUFBSSxFQUFFLElBQUksQ0FBQyxJQUFJO29DQUNmLGFBQWEsRUFBRSxHQUFHLENBQUMsYUFBYTtvQ0FDaEMsRUFBRSxFQUFFLEdBQUcsQ0FBQyxFQUFFO29DQUNWLE9BQU8sRUFBRSxHQUFHLENBQUMsT0FBTztvQ0FDcEIsU0FBUyxFQUFFLEdBQUcsQ0FBQyxTQUFTO2lDQUMzQixDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsVUFBQSxPQUFPO29DQUNaLElBQUk7d0NBQ0EsRUFBRSxDQUFDLGNBQWMsQ0FBQyxhQUFhLEVBQUUsT0FBTyxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsQ0FBQztxQ0FDOUQ7b0NBQUMsT0FBTyxDQUFDLEVBQUU7cUNBQ1g7b0NBQ0QsRUFBRSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUM7Z0NBQzdCLENBQUMsQ0FBQyxDQUFDLENBQUM7NEJBQ1IsQ0FBQzt5QkFDSixDQUFDLENBQUM7cUJBQ047Z0JBQ0wsQ0FBQzthQUNKLENBQUMsQ0FBQztRQUNQLENBQUM7UUFDRCxJQUFJLEVBQUUsVUFB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QUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO0lBQ2xELEdBQUcsQ0FBQyxVQUFVLENBQUMsT0FBTyxHQUFHLE9BQU8sQ0FBQztJQUNqQyxJQUFJLEdBQUcsQ0FBQyxxQkFBcUIsRUFBRTtRQUMzQixHQUFHLENBQUMscUJBQXFCLENBQUMsT0FBTyxDQUFDLENBQUM7S0FDdEM7SUFDRCxFQUFFLENBQUMsR0FBRyxDQUFDLFVBQVUsQ0FBQyxPQUFPLENBQUMsQ0FBQztBQUMvQixDQUFDO0FBYkQsb0NBYUMiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBpbXBvcnQgR2V0VXNlckluZm9TdWNjZXNzQ2FsbGJhY2tSZXN1bHQgPSB3eC5HZXRVc2VySW5mb1N1Y2Nlc3NDYWxsYmFja1Jlc3VsdDtcbmltcG9ydCB7QXV0aEFwaSwgQXV0aFBvc3REYXRhfSBmcm9tICcuLi9hcGlzL2F1dGgtYXBpJztcbmltcG9ydCB7VXNlcn0gZnJvbSAnLi90eXBlcy91c2VyJztcbmltcG9ydCBHZXRVc2VySW5mb1N1Y2Nlc3NDYWxsYmFja1Jlc3VsdCA9IFdlY2hhdE1pbmlwcm9ncmFtLkdldFVzZXJJbmZvU3VjY2Vzc0NhbGxiYWNrUmVzdWx0O1xuaW1wb3J0IHtVc2VyQXBpfSBmcm9tICcuLi9hcGlzL3VzZXItYXBpJztcbmltcG9ydCB7SU15QXBwfSBmcm9tICcuLi9hcHAnO1xuXG5leHBvcnQgZnVuY3Rpb24gTG9naW4oY2I6IChwcm9maWxlOiBVc2VyKSA9PiB2b2lkKSB7XG4gICAgY29uc3QgYXV0aEFwaSA9IG5ldyBBdXRoQXBpKCk7XG4gICAgLy8g55m75b2VXG4gICAgd3gubG9naW4oe1xuICAgICAgICBzdWNjZXNzOiAoX3JlcykgPT4ge1xuICAgICAgICAgICAgLy8g6I635Y+W55So5oi35L+h5oGvXG4gICAgICAgICAgICB3eC5nZXRTZXR0aW5nKHtcbiAgICAgICAgICAgICAgICBzdWNjZXNzOiAocmVzKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChyZXMuYXV0aFNldHRpbmdbJ3Njb3BlLnVzZXJJbmZvJ10pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIOW3sue7j+aOiOadg++8jOWPr+S7peebtOaOpeiwg+eUqCBnZXRVc2VySW5mbyDojrflj5blpLTlg4/mmLXnp7DvvIzkuI3kvJrlvLnmoYZcbiAgICAgICAgICAgICAgICAgICAgICAgIHd4LmdldFVzZXJJbmZvKHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdWNjZXNzOiByZXMgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhdXRoQXBpLmF1dGgoPEF1dGhQb3N0RGF0YT57XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb2RlOiBfcmVzLmNvZGUsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbmNyeXB0ZWREYXRhOiByZXMuZW5jcnlwdGVkRGF0YSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGl2OiByZXMuaXYsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByYXdEYXRhOiByZXMucmF3RGF0YSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNpZ25hdHVyZTogcmVzLnNpZ25hdHVyZVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KS50aGVuKChhdXRoUmVzID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgd3guc2V0U3RvcmFnZVN5bmMoJ2FjY2Vzc1Rva2VuJywgYXV0aFJlcy5kYXRhLmFjY2Vzc1Rva2VuKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNiKGF1dGhSZXMuZGF0YS5wcm9maWxlKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSkpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0sXG4gICAgICAgIGZhaWw6IChfZXJyKSA9PiB7XG4gICAgICAgICAgICBjb25zb2xlLmxvZyhfZXJyKTtcbiAgICAgICAgfVxuICAgIH0pO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gQ2hlY2tMb2dpblN0YXR1cyhzdWNjZXNzQ2I6IChyZXM6IEdldFVzZXJJbmZvU3VjY2Vzc0NhbGxiYWNrUmVzdWx0KSA9PiB2b2lkLCBmYWlsQ2I/OiAoKSA9PiB2b2lkKSB7XG4gICAgY29uc29sZS5sb2coMTExKTtcbiAgICBjb25zdCBjbGVhckxvZ2luU3RhdHVzID0gKCkgPT4ge1xuICAgICAgICB3eC5yZW1vdmVTdG9yYWdlU3luYygnYWNjZXNzVG9rZW4nKTtcbiAgICAgICAgd3guc3dpdGNoVGFiKHtcbiAgICAgICAgICAgIHVybDogJy9wYWdlcy9teS9teSdcbiAgICAgICAgfSk7XG4gICAgfTtcbiAgICBjb25zdCB0b2tlbiA9IHd4LmdldFN0b3JhZ2VTeW5jKCdhY2Nlc3NUb2tlbicpO1xuICAgIGlmICghdG9rZW4pIHtcbiAgICAgICAgY2xlYXJMb2dpblN0YXR1cygpO1xuICAgICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgd3guY2hlY2tTZXNzaW9uKHtcbiAgICAgICAgc3VjY2VzczogKCkgPT4ge1xuICAgICAgICAgICAgd3guZ2V0U2V0dGluZyh7XG4gICAgICAgICAgICAgICAgc3VjY2VzczogKHJlcykgPT4ge1xuICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhyZXMpO1xuICAgICAgICAgICAgICAgICAgICBpZiAocmVzLmF1dGhTZXR0aW5nWydzY29wZS51c2VySW5mbyddKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB3eC5nZXRVc2VySW5mbyh7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgc3VjY2VzczogcmVzID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3VjY2Vzc0NiKHJlcyk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBmYWlsQ2IgJiYgZmFpbENiKCk7XG4gICAgICAgICAgICAgICAgICAgICAgICBjbGVhckxvZ2luU3RhdHVzKCk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIGZhaWw6ICgpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgZmFpbENiICYmIGZhaWxDYigpO1xuICAgICAgICAgICAgICAgICAgICBjbGVhckxvZ2luU3RhdHVzKCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0sXG4gICAgICAgIGZhaWw6ICgpID0+IHtcbiAgICAgICAgICAgIGZhaWxDYiAmJiBmYWlsQ2IoKTtcbiAgICAgICAgICAgIGNsZWFyTG9naW5TdGF0dXMoKTtcbiAgICAgICAgfVxuICAgIH0pO1xuICAgIC8vIH1cbn1cblxuZXhwb3J0IGZ1bmN0aW9uIEdldFByb2ZpbGUoYXBwOiBJTXlBcHAsIGNiOiAocHJvZmlsZTogVXNlcikgPT4gdm9pZCkge1xuICAgIGNvbnN0IHVzZXJBcGkgPSBuZXcgVXNlckFwaSgpO1xuICAgIHVzZXJBcGkucHJvZmlsZSgpLnRoZW4ocmVzID0+IHtcbiAgICAgICAgUHJvZmlsZVBhcnNlKGFwcCwgcmVzLCBjYik7XG4gICAgfSk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBQcm9maWxlUGFyc2UoYXBwOiBJTXlBcHAsIHByb2ZpbGU6IFVzZXIsIGNiOiAocHJvZmlsZTogVXNlcikgPT4gdm9pZCkge1xuICAgIGxldCByb2xlVHJhbnMgPSBbJycsICfmuLjlrqInLCAn566h55CG5ZGYJywgJ+aVmeW4iCcsICflrrbplb8nXTtcbiAgICBjb25zdCByb2xlcyA9IHByb2ZpbGUucm9sZXMuZmlsdGVyKHIgPT4gciAhPT0gMCkubWFwKHIgPT4gcm9sZVRyYW5zW3JdKTtcbiAgICBpZiAocm9sZXMubGVuZ3RoIDw9IDApIHtcbiAgICAgICAgcm9sZXMucHVzaCgn5ri45a6iJyk7XG4gICAgfVxuICAgIHByb2ZpbGUuaXNBZG1pbiA9IHByb2ZpbGUucm9sZXMuaW5kZXhPZigyKSA+IC0xO1xuICAgIHByb2ZpbGUuaXNUZWFjaGVyID0gcHJvZmlsZS5yb2xlcy5pbmRleE9mKDMpID4gLTE7XG4gICAgYXBwLmdsb2JhbERhdGEucHJvZmlsZSA9IHByb2ZpbGU7XG4gICAgaWYgKGFwcC51c2VySW5mb1JlYWR5Q2FsbGJhY2spIHtcbiAgICAgICAgYXBwLnVzZXJJbmZvUmVhZHlDYWxsYmFjayhwcm9maWxlKTtcbiAgICB9XG4gICAgY2IoYXBwLmdsb2JhbERhdGEucHJvZmlsZSk7XG59XG4iXX0=